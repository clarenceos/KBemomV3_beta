<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0a">
<title>CS Kettlebell EMOM Timer</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚è±</text></svg>">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0a0a0a;font-family:'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace;-webkit-tap-highlight-color:transparent;overflow-x:hidden}
  ::-webkit-scrollbar{display:none}
  input:focus,button:focus{outline:none}
  button{font-family:inherit}
  @keyframes glowPulse{0%,100%{box-shadow:0 0 10px var(--glow),0 0 20px var(--glow2)}50%{box-shadow:0 0 14px var(--glow),0 0 28px var(--glow2)}}
  input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;outline:none;background:transparent}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;border:2px solid #333;cursor:pointer}
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback,useMemo}=React;

/* ‚ïê‚ïê‚ïê CONSTANTS & UTILS ‚ïê‚ïê‚ïê */
const STORE_EX="emom-exercises",STORE_WK="emom-saved-workouts",STORE_LOGS="emom-logs",STORE_FAVS="emom-favorites",STORE_MUTE="emom-muted",STORE_CX="emom-complexes",STORE_ACCENT="emom-accent",STORE_SOUND="emom-sound",STORE_DISMISS="emom-dismiss-install",STORE_CD="emom-start-countdown",STORE_DEL_CX="emom-deleted-cx";
const DEF_REPS=10,DEF_WEIGHT=12;
const DEF_EXERCISES=["Two-hand swing","One-hand swing","Deadlift","Clean","Goblet squat","Double kettlebell front squat","Split squat","Bulgarian split squat","Strict overhead press","Push press","Floor press","Farmer carry","Suitcase carry","Rack carry","Overhead carry","Snatch","High pull","Clean and press","Thruster","Bent-over row","Renegade row","Gorilla row","Turkish get-up","Windmill","Russian twist","Halo","Lunges","Reverse lunges","Alternating swing","Clean and squat"];
const DEF_COMPLEXES=[{id:1,name:"ABC Complex",weight:16,movements:[{name:"Clean",reps:2},{name:"Strict overhead press",reps:1},{name:"Goblet squat",reps:3}]}];
const DEF_WORKOUTS=[{id:-1,name:"Foundation Five",sets:1,builtin:true,exercises:[{name:"Two-hand swing",reps:15,weight:16},{name:"Goblet squat",reps:12,weight:16},{name:"Clean and press",reps:6,weight:16},{name:"Clean and squat",reps:8,weight:16},{name:"Reverse lunges",reps:12,weight:16}]},{id:-2,name:"The Basics",sets:1,builtin:true,exercises:[{name:"Two-hand swing",reps:10,weight:16},{name:"Goblet squat",reps:10,weight:16}]}];
const ACCENTS=[{n:"Gold",h:"#eab308"},{n:"Red",h:"#ef4444"},{n:"Blue",h:"#3b82f6"},{n:"Green",h:"#22c55e"},{n:"Purple",h:"#a855f7"},{n:"Cyan",h:"#06b6d4"},{n:"Orange",h:"#f97316"},{n:"Pink",h:"#ec4899"},{n:"Lime",h:"#84cc16"},{n:"White",h:"#e5e5e5"}];
const SOUNDS=[
  {name:"Classic",wave:"sine",cF:600,cD:150,cV:0.5,gF:1000,gD:300,gV:0.7},
  {name:"Bell",wave:"triangle",cF:880,cD:200,cV:0.4,gF:1320,gD:350,gV:0.6},
  {name:"Pulse",wave:"square",cF:440,cD:80,cV:0.3,gF:660,gD:120,gV:0.5},
  {name:"Chirp",wave:"sine",cF:500,cD:180,cV:0.4,gF:800,gD:250,gV:0.6,chirp:true},
  {name:"Alert",wave:"sine",cF:700,cD:100,cV:0.5,gF:900,gD:100,gV:0.7,dbl:true}
];
const pl=(n,w)=>`${n} ${w}${n===1?"":"s"}`;
const store={get:k=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
const vib=(ms=10)=>{try{navigator.vibrate&&navigator.vibrate(ms)}catch{}};
const isCx=ex=>!!(ex&&ex.movements);
const exVol=ex=>isCx(ex)?ex.movements.reduce((s,m)=>s+m.reps,0)*(ex.weight||0):(ex.reps||0)*(ex.weight||0);
const exReps=ex=>isCx(ex)?ex.movements.reduce((s,m)=>s+m.reps,0):(ex.reps||0);
function timeOfDay(d){const h=d.getHours();return h<12?"Morning":h<17?"Afternoon":"Evening"}
function fmtDate(d){const mm=d.getMonth()+1,dd=d.getDate(),yy=d.getFullYear();let hh=d.getHours(),ap="AM";if(hh>=12){ap="PM";if(hh>12)hh-=12}if(hh===0)hh=12;const mn=d.getMinutes().toString().padStart(2,"0");return`${mm}/${dd}/${yy} ${hh}:${mn}${ap}`}
function fmtEl(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60;if(h>0)return`${h}:${m.toString().padStart(2,"0")}:${sc.toString().padStart(2,"0")}`;return`${m}:${sc.toString().padStart(2,"0")}`}
function fmt(s){return`${Math.floor(s/60)}:${(s%60).toString().padStart(2,"0")}`}
function rpeCol(v){if(v<=3)return"#22c55e";if(v<=5)return"#eab308";if(v<=7)return"#f97316";return"#ef4444"}
function calcStreak(logs){
  if(!logs.length)return 0;
  const dates=new Set(logs.map(l=>{const d=new Date(l.startTime);return`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`}));
  const today=new Date();let streak=0;let ck=new Date(today);
  const tk=`${ck.getFullYear()}-${ck.getMonth()}-${ck.getDate()}`;
  if(!dates.has(tk))ck.setDate(ck.getDate()-1);
  for(let i=0;i<365;i++){const k=`${ck.getFullYear()}-${ck.getMonth()}-${ck.getDate()}`;if(dates.has(k)){streak++;ck.setDate(ck.getDate()-1)}else break}
  return streak;
}
function getPR(logs){if(!logs.length)return 0;return Math.max(0,...logs.filter(l=>!l.freestyle).map(l=>l.totalVolume||0))}
const isStandalone=()=>{try{return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===true}catch{return false}};

/* ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê */
function mkBeep(acRef,p,type,muted){
  // iOS PWA: after returning from background, WebAudio often requires a fresh user gesture.
  // If we try to beep before any gesture, iOS will block it; skip instead.
  if(typeof window!=="undefined" && window.__CS_AUDIO_NEEDS_GESTURE) return;
  if(muted&&muted.current)return;
  if(!acRef||!acRef.current)return;
  try{
    const ac=acRef.current;if(ac.state==="closed")return;if(ac.state==="suspended"&&ac.resume)ac.resume().catch(()=>{});
    const go=type==="go",f=go?p.gF:p.cF,d=go?p.gD:p.cD,v=go?p.gV:p.cV;
    const tone=(freq,dur,vol,del=0)=>{const o=ac.createOscillator(),g=ac.createGain();o.type=p.wave;o.connect(g);g.connect(ac.destination);o.frequency.value=freq;g.gain.value=vol;if(p.chirp){o.frequency.setValueAtTime(freq,ac.currentTime+del);o.frequency.linearRampToValueAtTime(freq*1.5,ac.currentTime+del+dur/1000)}o.start(ac.currentTime+del);o.stop(ac.currentTime+del+dur/1000)};
    tone(f,d,v);if(p.dbl&&go)tone(f*1.2,d,v,0.15);
  }catch{}
}
function demoSnd(p){
  let ac;try{ac=new(window.AudioContext||window.webkitAudioContext)()}catch{return}
  const t=(f,d,v,del)=>{const o=ac.createOscillator(),g=ac.createGain();o.type=p.wave;o.connect(g);g.connect(ac.destination);o.frequency.value=f;g.gain.value=v;if(p.chirp){o.frequency.setValueAtTime(f,ac.currentTime+del);o.frequency.linearRampToValueAtTime(f*1.5,ac.currentTime+del+d/1000)}o.start(ac.currentTime+del);o.stop(ac.currentTime+del+d/1000)};
  t(p.cF,p.cD,p.cV,0);t(p.cF,p.cD,p.cV,0.8);t(p.cF,p.cD,p.cV,1.6);setTimeout(()=>t(p.gF,p.gD,p.gV,0),2400);
}

/* ‚ïê‚ïê‚ïê HOOKS ‚ïê‚ïê‚ïê */
function useExLib(){
  const[lib,setLib]=useState(()=>{const c=store.get(STORE_EX);if(c&&Array.isArray(c)){const m=[...DEF_EXERCISES];c.forEach(x=>{if(!m.some(e=>e.toLowerCase()===x.toLowerCase()))m.push(x)});return m}return[...DEF_EXERCISES]});
  const add=useCallback(name=>{const t=name.trim();if(!t)return;setLib(p=>{if(p.some(e=>e.toLowerCase()===t.toLowerCase()))return p;const n=[...p,t];store.set(STORE_EX,n.filter(x=>!DEF_EXERCISES.some(d=>d.toLowerCase()===x.toLowerCase())));return n})},[]);
  return{lib,add};
}
function useWorkouts(){
  const[userWk,setUserWk]=useState(()=>store.get(STORE_WK)||[]);
  const wk=useMemo(()=>[...DEF_WORKOUTS,...userWk],[userWk]);
  const save=useCallback((name,ex,sets)=>setUserWk(p=>{const n=[...p,{id:Date.now(),name,exercises:ex,sets:sets||1}];store.set(STORE_WK,n);return n}),[]);
  const del=useCallback(id=>setUserWk(p=>{const n=p.filter(w=>w.id!==id);store.set(STORE_WK,n);return n}),[]);
  return{wk,save,del};
}
function useLogs(){
  const[logs,setLogs]=useState(()=>store.get(STORE_LOGS)||[]);
  const add=useCallback(e=>{setLogs(p=>{const n=[e,...p];store.set(STORE_LOGS,n);return n})},[]);
  const del=useCallback(id=>{setLogs(p=>{const n=p.filter(l=>l.id!==id);store.set(STORE_LOGS,n);return n})},[]);
  const upd=useCallback((id,u)=>{setLogs(p=>{const n=p.map(l=>l.id===id?{...l,...u}:l);store.set(STORE_LOGS,n);return n})},[]);
  const reset=useCallback(()=>{setLogs([]);store.set(STORE_LOGS,[])},[]);
  return{logs,add,del,upd,reset};
}
function useFavs(){
  const[favs,setFavs]=useState(()=>store.get(STORE_FAVS)||[]);
  const toggle=useCallback(name=>{setFavs(p=>{const n=p.includes(name)?p.filter(f=>f!==name):[...p,name];store.set(STORE_FAVS,n);return n})},[]);
  return{favs,toggle};
}
function useCxLib(){
  const[userCxs,setUserCxs]=useState(()=>store.get(STORE_CX)||[]);
  const[delCxs,setDelCxs]=useState(()=>store.get(STORE_DEL_CX)||[]);
  const cxs=useMemo(()=>{const merged=DEF_COMPLEXES.filter(c=>!delCxs.includes(c.name.toLowerCase()));userCxs.forEach(uc=>{if(!merged.some(c=>c.name.toLowerCase()===uc.name.toLowerCase()))merged.push(uc)});return merged},[userCxs,delCxs]);
  const save=useCallback(cx=>{setUserCxs(p=>{const idx=p.findIndex(c=>c.name.toLowerCase()===cx.name.toLowerCase());let n;if(idx>=0){n=[...p];n[idx]={...cx,id:p[idx].id}}else{n=[...p,{...cx,id:Date.now()}]}store.set(STORE_CX,n);return n})},[]);
  const del=useCallback(name=>{const lo=name.toLowerCase();setUserCxs(p=>{const n=p.filter(c=>c.name.toLowerCase()!==lo);store.set(STORE_CX,n);return n});if(DEF_COMPLEXES.some(c=>c.name.toLowerCase()===lo)){setDelCxs(p=>{const n=[...p,lo];store.set(STORE_DEL_CX,n);return n})}},[]); 
  const restoreDefaults=useCallback(()=>{setDelCxs([]);store.set(STORE_DEL_CX,[])},[]);
  return{cxs,save,del,restoreDefaults};
}
function useSwipe(onBack){
  const ref=useRef(null);
  useEffect(()=>{const el=ref.current;if(!el)return;let sx=0,sy=0,tr=false;
    const ts=e=>{const t=e.touches[0];if(t.clientX<40){sx=t.clientX;sy=t.clientY;tr=true}};
    const tm=e=>{if(!tr)return;const t=e.touches[0];if(t.clientX-sx>80&&Math.abs(t.clientY-sy)<50){tr=false;onBack()}};
    const te=()=>{tr=false};
    el.addEventListener("touchstart",ts,{passive:true});el.addEventListener("touchmove",tm,{passive:true});el.addEventListener("touchend",te,{passive:true});
    return()=>{el.removeEventListener("touchstart",ts);el.removeEventListener("touchmove",tm);el.removeEventListener("touchend",te)};
  },[onBack]);
  return ref;
}

/* ‚ïê‚ïê‚ïê SMALL COMPONENTS ‚ïê‚ïê‚ïê */
function Confirm({title,message,confirmText="Confirm",confirmColor="#ef4444",onConfirm,onCancel}){
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>{title}</h3>
    <p style={{textAlign:"center",color:"#a3a3a3",fontSize:14,margin:"0 0 20px",lineHeight:1.6}}>{message}</p>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={onConfirm} style={{...S.modalBtn,flex:1,marginTop:0,background:confirmColor,color:"#fff",fontWeight:700}}>{confirmText}</button>
    </div>
  </div></div>);
}
function NumInput({value,onChange,max,label}){
  const h=e=>{const r=e.target.value.replace(/[^0-9]/g,"");if(r===""){onChange(0);return}onChange(Math.min(parseInt(r,10),max))};
  return(<div style={{flex:1}}><label style={S.editLabel}>{label}</label><input type="text" inputMode="numeric" pattern="[0-9]*" value={String(value)} onChange={h} style={{...S.input,textAlign:"center",fontSize:18,fontWeight:700}}/></div>);
}
function EditModal({exercise,onSave,onCancel}){
  const[reps,setReps]=useState(exercise.reps);const[weight,setWeight]=useState(exercise.weight);
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Edit Exercise</h3>
    <p style={{textAlign:"center",color:"#eab308",fontSize:14,fontWeight:600,margin:"0 0 16px"}}>{exercise.name}</p>
    <div style={{display:"flex",gap:12,marginBottom:16}}><NumInput value={reps} onChange={setReps} max={99} label="Reps"/><NumInput value={weight} onChange={setWeight} max={99} label="Weight (kg)"/></div>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={()=>onSave({reps,weight})} style={{...S.modalBtn,flex:1,marginTop:0,background:"#eab308",color:"#0a0a0a",fontWeight:700}}>Save</button>
    </div>
  </div></div>);
}
function ScrollPicker({value,onChange,max=20,suffix}){
  const ref=useRef(null);const H=36;const lastSnap=useRef(value);
  useEffect(()=>{const el=ref.current;if(!el)return;el.scrollTop=value*H;const t1=setTimeout(()=>{el.scrollTop=value*H},50);const t2=setTimeout(()=>{el.scrollTop=value*H},150);return()=>{clearTimeout(t1);clearTimeout(t2)}},[]);
  useEffect(()=>{if(ref.current){const c=Math.round(ref.current.scrollTop/H);if(c!==value)ref.current.scrollTo({top:value*H,behavior:"smooth"})}},[value]);
  const hs=()=>{if(!ref.current)return;const c=Math.max(0,Math.min(max,Math.round(ref.current.scrollTop/H)));if(c!==value){if(c!==lastSnap.current){lastSnap.current=c;vib(10)}onChange(c)}};
  return(
    <div style={{position:"relative",width:80,height:120,flexShrink:0}}>
      <div style={{position:"absolute",top:"50%",left:2,right:2,height:38,transform:"translateY(-50%)",border:"2px solid #eab308",borderRadius:8,pointerEvents:"none",zIndex:1}}/>
      <div style={{position:"absolute",top:0,left:0,right:0,height:36,background:"linear-gradient(to bottom,#0a0a0a,transparent)",pointerEvents:"none",zIndex:1}}/>
      <div style={{position:"absolute",bottom:0,left:0,right:0,height:36,background:"linear-gradient(to top,#0a0a0a,transparent)",pointerEvents:"none",zIndex:1}}/>
      <div ref={ref} onScroll={hs} style={{height:"100%",overflowY:"scroll",scrollSnapType:"y mandatory",WebkitOverflowScrolling:"touch",scrollbarWidth:"none",msOverflowStyle:"none"}}>
        <div style={{height:H*1.5}}/>{Array.from({length:max+1},(_,i)=>(
          <div key={i} onClick={()=>ref.current?.scrollTo({top:i*H,behavior:"smooth"})} style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",scrollSnapAlign:"center",cursor:"pointer",userSelect:"none",color:i===value?"#eab308":"#555",fontWeight:i===value?800:400,fontSize:i===value?20:14,transition:"all 0.12s",fontFamily:"inherit",gap:4}}>
            {i}{i===value&&suffix?<span style={{fontSize:11,color:"#999",fontWeight:600}}>{suffix}</span>:null}
          </div>
        ))}<div style={{height:H*1.5}}/>
      </div>
    </div>
  );
}
function ProgBar({current,total,sets,accent}){
  const pct=Math.min(100,((current+0.5)/total)*100);
  return(<div style={{width:"100%",margin:"6px 0 2px"}}>
    <div style={{position:"relative",height:4,background:"#1a1a1a",borderRadius:2,overflow:"visible"}}>
      <div style={{height:"100%",width:`${pct}%`,background:accent,borderRadius:2,position:"relative",minWidth:4,transition:"width 0.3s"}}>
        <div style={{position:"absolute",right:-1,top:-3,width:10,height:10,background:accent,borderRadius:"50%",boxShadow:`0 0 10px ${accent}99,0 0 20px ${accent}55`,animation:"glowPulse 1.5s infinite","--glow":`${accent}99`,"--glow2":`${accent}55`}}/>
      </div>
      {sets>1&&Array.from({length:sets-1},(_,i)=>{const pos=((i+1)/sets)*100;return <div key={i} style={{position:"absolute",top:-6,left:`${pos}%`,width:2,height:16,background:"#666",borderRadius:1}}/>})}
    </div>
    <div style={{fontSize:8,color:"#333",textAlign:"right",marginTop:2}}>{current+1} / {total}</div>
  </div>);
}
function RPESlider({value,onChange}){
  const[active,setActive]=useState(value!==null);
  const grad="linear-gradient(90deg,#22c55e 0%,#eab308 40%,#f97316 65%,#ef4444 100%)";
  return(<div style={{width:"100%",maxWidth:360,margin:"0 auto"}}>
    <div style={{fontSize:10,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:8,textAlign:"center"}}>Rate of Perceived Exertion</div>
    {!active?(<button onClick={()=>{setActive(true);onChange(5)}} style={{width:"100%",padding:10,background:"#141414",border:"1px solid #262626",borderRadius:8,color:"#555",fontSize:12,cursor:"pointer",fontFamily:"inherit"}}>Tap to rate RPE (1-10)</button>
    ):(<div>
      <div style={{textAlign:"center",marginBottom:8}}><span style={{fontSize:28,fontWeight:800,color:rpeCol(value)}}>{value}</span><span style={{fontSize:12,color:"#555"}}>/10</span></div>
      <div style={{position:"relative",margin:"0 4px"}}>
        <div style={{height:6,borderRadius:3,background:grad,position:"absolute",width:"100%",top:9}}/>
        <input type="range" min="1" max="10" value={value} onChange={e=>onChange(parseInt(e.target.value))} style={{position:"relative",zIndex:1,background:"transparent",WebkitAppearance:"none",width:"100%",height:24,cursor:"pointer"}}/>
        <style>{`input[type=range]::-webkit-slider-thumb{background:${rpeCol(value)};width:24px;height:24px;border-radius:50%;border:2px solid #333;-webkit-appearance:none}`}</style>
      </div>
      <div style={{display:"flex",justifyContent:"space-between",fontSize:9,color:"#555",marginTop:4}}><span>Easy</span><span>Max Effort</span></div>
    </div>)}
  </div>);
}
function IntensityMeter({volume}){
  let pct,color,label;
  if(volume<=0){pct=0;color="#333";label="‚Äî"}
  else if(volume<1000){pct=volume/2000*40;color="#22c55e";label="Light"}
  else if(volume<2000){pct=20+(volume-1000)/1000*20;color="#22c55e";label="Light"}
  else if(volume<2750){pct=40+(volume-2000)/750*20;color="#eab308";label="Moderate"}
  else if(volume<3500){pct=60+(volume-2750)/750*20;color="#f97316";label="Hard"}
  else{pct=Math.min(100,80+(volume-3500)/1500*20);color="#ef4444";label="Intense"}
  return(<div style={{marginTop:8}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
      <span style={{fontSize:10,letterSpacing:2,color:"#555",textTransform:"uppercase"}}>Intensity</span>
      <span style={{fontSize:12,fontWeight:700,color}}>{label}</span>
    </div>
    <div style={{height:6,borderRadius:3,background:"#1a1a1a",overflow:"hidden"}}>
      <div style={{height:"100%",borderRadius:3,width:`${pct}%`,background:`linear-gradient(90deg,#22c55e,${color})`,transition:"width 0.4s,background 0.4s"}}/>
    </div>
  </div>);
}
function StatsBar({exercises,sets}){
  const tt=exercises.length*sets,tv=exercises.reduce((s,e)=>s+exVol(e),0)*sets;
  return(<div style={S.statsBar}>
    <div style={{display:"flex",justifyContent:"center",gap:20,alignItems:"baseline"}}>
      <div style={S.statBlk}><span style={S.statVal}>{tt}</span><span style={S.statLbl}>min</span></div>
      <div style={{width:1,height:24,background:"#262626"}}/>
      <div style={S.statBlk}><span style={S.statVal}>{tv.toLocaleString()}</span><span style={S.statLbl}>kg vol</span></div>
    </div>
    <IntensityMeter volume={tv}/>
  </div>);
}
function SetsSelector({sets,onChange}){
  return(<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:16,marginBottom:12}}>
    <button onClick={()=>onChange(Math.max(1,sets-1))} style={S.setsBtn}>‚àí</button>
    <div style={{textAlign:"center",minWidth:60}}><span style={{fontSize:24,fontWeight:800,color:"#fafafa"}}>{sets}</span><span style={{fontSize:11,color:"#555",letterSpacing:2,display:"block",marginTop:2}}>{sets===1?"SET":"SETS"}</span></div>
    <button onClick={()=>onChange(Math.min(100,sets+1))} style={S.setsBtn}>+</button>
  </div>);
}
function Header({title,onBack}){
  return(<div style={{paddingTop:"max(16px, env(safe-area-inset-top, 16px))",marginBottom:20}}>
    <div style={{display:"flex",alignItems:"center",gap:12}}>
      <button onClick={onBack} style={{background:"none",border:"1px solid #333",borderRadius:8,color:"#eab308",fontSize:16,cursor:"pointer",padding:"8px 14px",fontWeight:700,fontFamily:"inherit"}}>‚Üê Back</button>
      <h2 style={{fontSize:18,fontWeight:700,letterSpacing:3,color:"#fafafa",textTransform:"uppercase"}}>{title}</h2>
    </div>
  </div>);
}

/* ‚ïê‚ïê‚ïê DROPDOWNS ‚ïê‚ïê‚ïê */
function ExDD({value,onChange,lib,onCustom,favs,toggleFav,cxs,onPickCx,onDelCx}){
  const[open,setOpen]=useState(false);const[f,setF]=useState("");const ref=useRef(null);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false)};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h)},[]);
  const filtered=lib.filter(e=>e.toLowerCase().includes(f.toLowerCase()));
  const sorted=[...filtered].sort((a,b)=>(favs.includes(a)?0:1)-(favs.includes(b)?0:1));
  const hasFavs=sorted.some(e=>favs.includes(e));
  const fCx=cxs.filter(cx=>cx.name.toLowerCase().includes(f.toLowerCase()));
  return(
    <div ref={ref} style={{position:"relative",flex:1,minWidth:0}}>
      <button onClick={()=>setOpen(!open)} style={{...S.input,cursor:"pointer",textAlign:"left",display:"flex",justifyContent:"space-between",alignItems:"center",color:value?"#fafafa":"#888",fontWeight:value?400:500,height:44}}>
        <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{value||"Select exercise"}</span>
        <span style={{fontSize:10,color:"#555",marginLeft:8,flexShrink:0}}>{open?"‚ñ≤":"‚ñº"}</span>
      </button>
      {open&&(<div style={S.dropdown}>
        <input type="text" value={f} placeholder="Search or type new‚Ä¶" onChange={e=>setF(e.target.value)} autoFocus style={{...S.input,borderRadius:0,borderBottom:"1px solid #333",position:"sticky",top:0,zIndex:2,background:"#1c1c1c"}}/>
        <div style={{maxHeight:250,overflowY:"auto"}}>
          {fCx.length>0&&(<>
            <div style={{padding:"8px 14px",fontSize:10,letterSpacing:2,color:"#555",textTransform:"uppercase",background:"#151515"}}>üì¶ My Complexes</div>
            {fCx.map(cx=>(<div key={cx.id} style={{...S.ddItem,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <span style={{color:"#eab308",flex:1,cursor:"pointer"}} onMouseDown={()=>{onPickCx(cx);setF("");setOpen(false)}}>{cx.name}</span>
              <span style={{fontSize:11,color:"#555",marginRight:8}}>{cx.movements.length} moves</span>
              <span onClick={e=>{e.stopPropagation();onDelCx(cx.name)}} style={{cursor:"pointer",fontSize:12,color:"#ef4444",opacity:0.5,padding:"0 4px"}}>‚úï</span>
            </div>))}
            <div style={{height:1,background:"#333",margin:"2px 0"}}/>
          </>)}
          {sorted.map((ex,i)=>{
            const isF=favs.includes(ex);
            const divider=hasFavs&&i>0&&!isF&&favs.includes(sorted[i-1]);
            return(<React.Fragment key={ex}>
              {divider&&<div style={{height:1,background:"#333",margin:"4px 0"}}/>}
              <div style={{...S.ddItem,background:ex===value?"rgba(234,179,8,0.1)":"transparent",display:"flex",justifyContent:"space-between"}}>
                <span style={{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}} onMouseDown={()=>{onChange(ex);setF("");setOpen(false)}}>{ex}</span>
                <span onClick={e=>{e.stopPropagation();toggleFav(ex)}} style={{cursor:"pointer",fontSize:14,marginLeft:8,opacity:isF?1:0.3}}>{isF?"‚òÖ":"‚òÜ"}</span>
              </div>
            </React.Fragment>);
          })}
          {f.trim()&&!lib.some(e=>e.toLowerCase()===f.trim().toLowerCase())&&(
            <div style={{...S.ddItem,color:"#eab308",fontStyle:"italic"}} onMouseDown={()=>{onCustom(f.trim());onChange(f.trim());setF("");setOpen(false)}}>+ Add "{f.trim()}"</div>
          )}
        </div>
      </div>)}
    </div>
  );
}
function SmDD({value,onChange,items}){
  const[open,setOpen]=useState(false);const[f,setF]=useState("");const ref=useRef(null);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false)};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h)},[]);
  const filtered=(items||DEF_EXERCISES).filter(e=>e.toLowerCase().includes(f.toLowerCase()));
  return(
    <div ref={ref} style={{position:"relative",flex:1}}>
      <button onClick={()=>setOpen(!open)} style={{...S.input,cursor:"pointer",textAlign:"left",display:"flex",justifyContent:"space-between",height:38,fontSize:13,padding:"6px 10px",color:value?"#fafafa":"#666"}}>
        <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{value||"Select movement"}</span>
        <span style={{fontSize:9,color:"#555"}}>‚ñº</span>
      </button>
      {open&&(<div style={{...S.dropdown,maxHeight:200}}>
        <input type="text" value={f} placeholder="Search‚Ä¶" onChange={e=>setF(e.target.value)} autoFocus style={{...S.input,borderRadius:0,borderBottom:"1px solid #333",position:"sticky",top:0,zIndex:2,background:"#1c1c1c",fontSize:12,padding:"8px 10px"}}/>
        <div style={{maxHeight:150,overflowY:"auto"}}>
          {filtered.map(ex=>(<div key={ex} style={{...S.ddItem,fontSize:13,padding:"9px 12px"}} onMouseDown={()=>{onChange(ex);setF("");setOpen(false)}}>{ex}</div>))}
        </div>
      </div>)}
    </div>
  );
}

/* ‚ïê‚ïê‚ïê COMPLEX BUILDER ‚ïê‚ïê‚ïê */
function CxBuilder({initial,onSave,onCancel,lib}){
  const[name,setName]=useState(initial?.name||"");
  const[weight,setWeight]=useState(initial?.weight||16);
  const[moves,setMoves]=useState(initial?.movements?initial.movements.map((m,i)=>({...m,id:m.id||Date.now()+i})):[]);
  const[sel,setSel]=useState("");const[sr,setSr]=useState(3);
  const addM=()=>{if(!sel||moves.length>=5)return;setMoves(p=>[...p,{id:Date.now(),name:sel,reps:sr}]);setSel("")};
  const remM=id=>setMoves(p=>p.filter(m=>m.id!==id));
  const upM=i=>setMoves(p=>{const n=[...p];if(i<=0)return n;[n[i-1],n[i]]=[n[i],n[i-1]];return n});
  const tr=moves.reduce((s,m)=>s+m.reps,0);
  const ok=moves.length>=2&&name.trim();
  return(<div style={S.overlay}><div style={{...S.modal,maxWidth:400}}>
    <h3 style={S.modalTitle}>{initial?"Edit Complex":"Create Complex"}</h3>
    <input type="text" value={name} onChange={e=>setName(e.target.value)} placeholder="Complex name (e.g. Armor Builder)" style={{...S.input,marginBottom:12,fontSize:13}}/>
    {moves.length<5&&(<div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center"}}>
      <SmDD value={sel} onChange={setSel} items={lib}/>
      <div style={{display:"flex",alignItems:"center",gap:4,background:"#171717",border:"1px solid #262626",borderRadius:8,padding:"0 10px",height:38}}>
        <button onClick={()=>setSr(Math.max(1,sr-1))} style={{background:"none",border:"none",color:"#737373",fontSize:16,cursor:"pointer",padding:"0 2px"}}>‚àí</button>
        <span style={{fontSize:14,fontWeight:700,minWidth:20,textAlign:"center",color:"#eab308"}}>{sr}</span>
        <button onClick={()=>setSr(Math.min(20,sr+1))} style={{background:"none",border:"none",color:"#737373",fontSize:16,cursor:"pointer",padding:"0 2px"}}>+</button>
      </div>
      <button onClick={addM} disabled={!sel} style={{background:"#eab308",color:"#0a0a0a",border:"none",borderRadius:8,width:36,height:38,fontSize:18,fontWeight:700,cursor:"pointer",flexShrink:0,opacity:sel?1:0.35}}>+</button>
    </div>)}
    {moves.length>=5&&<p style={{fontSize:11,color:"#f97316",textAlign:"center",marginBottom:12}}>Maximum 5 movements</p>}
    {moves.length>0?(<div style={{marginBottom:12}}>
      {moves.map((m,i)=>(<div key={m.id} style={{display:"flex",alignItems:"center",gap:8,padding:"8px 0",borderBottom:i<moves.length-1?"1px solid #1a1a1a":"none"}}>
        <span style={{fontSize:12,color:"#555",width:16,textAlign:"center"}}>{i+1}</span>
        <span style={{flex:1,fontSize:13,fontWeight:600}}>{m.name}</span>
        <span style={{fontSize:12,color:"#eab308",fontWeight:700}}>{m.reps}r</span>
        <button onClick={()=>upM(i)} disabled={i===0} style={{...S.microBtn,opacity:i===0?0.3:1}}>‚Üë</button>
        <button onClick={()=>remM(m.id)} style={{...S.microBtn,color:"#ef4444"}}>‚úï</button>
      </div>))}
    </div>):(<p style={{fontSize:12,color:"#444",textAlign:"center",padding:"20px 0"}}>Add 2-5 movements to build your complex</p>)}
    {moves.length>0&&(<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,padding:"12px 0",borderTop:"1px solid #1a1a1a",marginBottom:12}}>
      <span style={{fontSize:11,color:"#555",letterSpacing:2}}>WEIGHT</span>
      <button onClick={()=>setWeight(Math.max(0,weight-2))} style={S.wBtn}>‚àí</button>
      <span style={{fontSize:20,fontWeight:800,color:"#eab308",minWidth:40,textAlign:"center"}}>{weight}<span style={{fontSize:11,fontWeight:600,color:"#777"}}>kg</span></span>
      <button onClick={()=>setWeight(Math.min(99,weight+2))} style={S.wBtn}>+</button>
    </div>)}
    {moves.length>=2&&(<div style={{background:"#0a0a0a",borderRadius:8,padding:12,marginBottom:16,textAlign:"center"}}>
      <span style={{fontSize:9,letterSpacing:2,color:"#555",textTransform:"uppercase",display:"block",marginBottom:6}}>Timer Preview</span>
      <span style={{fontSize:15,fontWeight:700,letterSpacing:1,display:"block",textTransform:"uppercase"}}>{name||"Complex"}</span>
      <span style={{fontSize:13,color:"#eab308",display:"block",marginTop:2}}>{moves.map(m=>`${m.reps} ${m.name.toLowerCase()}`).join(" ‚Üí ")}</span>
      <span style={{fontSize:12,color:"#555",display:"block",marginTop:2}}>{tr} reps ¬∑ {weight}kg ¬∑ {tr*weight}kg vol</span>
    </div>)}
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={()=>{if(ok)onSave({name:name.trim(),weight,movements:moves.map(({name,reps})=>({name,reps}))})}} disabled={!ok} style={{...S.modalBtn,flex:1,marginTop:0,background:ok?"#eab308":"#333",color:ok?"#0a0a0a":"#666",fontWeight:700}}>{moves.length<2?"Need 2+ moves":"Save Complex"}</button>
    </div>
  </div></div>);
}
function CxQuickEdit({entry,onSave,onFull,onCancel}){
  const[w,setW]=useState(entry.weight);
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Edit Complex</h3>
    <p style={{textAlign:"center",color:"#eab308",fontSize:14,fontWeight:600,margin:"0 0 12px"}}>{entry.name}</p>
    <div style={{background:"#0a0a0a",borderRadius:8,padding:12,marginBottom:16}}>
      {entry.movements.map((m,i)=>(<div key={i} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:13}}><span style={{color:"#a3a3a3"}}>{m.reps} {m.name}</span></div>))}
    </div>
    <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginBottom:16}}>
      <span style={{fontSize:11,color:"#555",letterSpacing:2}}>WEIGHT</span>
      <button onClick={()=>setW(Math.max(0,w-2))} style={S.wBtn}>‚àí</button>
      <span style={{fontSize:20,fontWeight:800,color:"#eab308",minWidth:40,textAlign:"center"}}>{w}<span style={{fontSize:11,fontWeight:600,color:"#777"}}>kg</span></span>
      <button onClick={()=>setW(Math.min(99,w+2))} style={S.wBtn}>+</button>
    </div>
    <button onClick={onFull} style={{background:"none",border:"none",color:"#737373",fontSize:12,cursor:"pointer",textAlign:"center",width:"100%",padding:8,textDecoration:"underline",marginBottom:8}}>Edit movements ‚Üí</button>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={()=>onSave({weight:w})} style={{...S.modalBtn,flex:1,marginTop:0,background:"#eab308",color:"#0a0a0a",fontWeight:700}}>Save</button>
    </div>
  </div></div>);
}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
function SaveModal({onSave,onCancel}){
  const[n,setN]=useState("");
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Save Workout</h3>
    <input type="text" value={n} onChange={e=>setN(e.target.value)} placeholder="Workout name" autoFocus style={{...S.input,marginBottom:16,width:"100%"}}/>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={()=>n.trim()&&onSave(n.trim())} disabled={!n.trim()} style={{...S.modalBtn,flex:1,marginTop:0,background:n.trim()?"#eab308":"#333",color:n.trim()?"#0a0a0a":"#666",fontWeight:700}}>Save</button>
    </div>
  </div></div>);
}
function LoadModal({wk,onLoad,onDel,onCancel}){
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Load Workout</h3>
    {wk.length===0&&<p style={{textAlign:"center",color:"#666",fontSize:14}}>No saved workouts yet</p>}
    {wk.map(w=>(<div key={w.id} style={S.loadItem}>
      <div style={{flex:1,cursor:"pointer"}} onClick={()=>onLoad(w)}><span style={{display:"flex",alignItems:"center",gap:6,fontSize:14,fontWeight:600}}>{w.name}{w.builtin&&<span style={{fontSize:9,color:"#eab308",fontWeight:700,background:"rgba(234,179,8,0.15)",padding:"1px 6px",borderRadius:3}}>PRESET</span>}</span><span style={{display:"block",fontSize:12,color:"#737373",marginTop:2}}>{pl(w.exercises.length,"round")}{w.sets>1?` √ó ${w.sets} sets`:""}</span></div>
      {!w.builtin&&<button onClick={()=>onDel(w.id)} style={{...S.microBtn,color:"#ef4444"}}>‚úï</button>}
    </div>))}
    <button onClick={onCancel} style={S.modalBtn}>Close</button>
  </div></div>);
}
function FreestyleSetup({onStart,onCancel}){
  const[dur,setDur]=useState("");
  const handleDur=e=>{const v=e.target.value.replace(/[^0-9]/g,"");setDur(v)};
  const mins=parseInt(dur,10);const valid=mins>0&&mins<=999;
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Freestyle Mode</h3>
    <p style={{textAlign:"center",color:"#a3a3a3",fontSize:13,margin:"0 0 16px",lineHeight:1.6}}>No exercises, no program. Just you, your kettlebell, and the clock.</p>
    <div style={{marginBottom:16}}>
      <label style={{display:"block",fontSize:10,color:"#555",letterSpacing:2,textTransform:"uppercase",marginBottom:6,textAlign:"center"}}>Duration (minutes)</label>
      <input type="text" inputMode="numeric" pattern="[0-9]*" value={dur} onChange={handleDur} placeholder="e.g. 10" autoFocus style={{...S.input,textAlign:"center",fontSize:20,fontWeight:700}}/>
    </div>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={()=>{if(valid)onStart(mins)}} disabled={!valid} style={{...S.modalBtn,flex:1,marginTop:0,background:valid?"#eab308":"#333",color:valid?"#0a0a0a":"#666",fontWeight:700}}>Start Freestyle</button>
    </div>
  </div></div>);
}
function FreestyleLogModal({rounds,onSave,onSkip,lib}){
  const[entries,setEntries]=useState([]);const[sel,setSel]=useState("");const[reps,setReps]=useState(10);const[wt,setWt]=useState(16);
  const addE=()=>{if(!sel)return;setEntries(p=>[...p,{id:Date.now(),name:sel,reps,weight:wt}]);setSel("")};
  const tv=entries.reduce((s,e)=>s+e.reps*(e.weight||0),0);
  return(<div style={S.overlay}><div style={{...S.modal,maxWidth:400}}>
    <h3 style={S.modalTitle}>Log Freestyle Exercises?</h3>
    <p style={{textAlign:"center",color:"#a3a3a3",fontSize:12,margin:"0 0 16px",lineHeight:1.6}}>{pl(rounds,"round")} completed. Add exercises to your stats.</p>
    <div style={{display:"flex",gap:6,marginBottom:12,alignItems:"center"}}>
      <SmDD value={sel} onChange={setSel} items={lib}/>
      <div style={{display:"flex",alignItems:"center",gap:2,background:"#171717",border:"1px solid #262626",borderRadius:8,padding:"0 8px",height:38}}>
        <button onClick={()=>setReps(Math.max(1,reps-1))} style={{background:"none",border:"none",color:"#737373",fontSize:14,cursor:"pointer"}}>‚àí</button>
        <span style={{fontSize:13,fontWeight:700,color:"#eab308",minWidth:18,textAlign:"center"}}>{reps}</span>
        <button onClick={()=>setReps(Math.min(99,reps+1))} style={{background:"none",border:"none",color:"#737373",fontSize:14,cursor:"pointer"}}>+</button>
      </div>
      <div style={{display:"flex",alignItems:"center",gap:2,background:"#171717",border:"1px solid #262626",borderRadius:8,padding:"0 8px",height:38}}>
        <button onClick={()=>setWt(Math.max(0,wt-2))} style={{background:"none",border:"none",color:"#737373",fontSize:14,cursor:"pointer"}}>‚àí</button>
        <span style={{fontSize:13,fontWeight:700,color:"#eab308",minWidth:22,textAlign:"center"}}>{wt}</span>
        <span style={{fontSize:9,color:"#666"}}>kg</span>
        <button onClick={()=>setWt(Math.min(99,wt+2))} style={{background:"none",border:"none",color:"#737373",fontSize:14,cursor:"pointer"}}>+</button>
      </div>
      <button onClick={addE} disabled={!sel} style={{background:"#eab308",color:"#0a0a0a",border:"none",borderRadius:8,width:32,height:38,fontSize:16,fontWeight:700,cursor:"pointer",flexShrink:0,opacity:sel?1:0.35}}>+</button>
    </div>
    {entries.length>0&&(<div style={{marginBottom:12}}>
      {entries.map((e,i)=>(<div key={e.id} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:i<entries.length-1?"1px solid #1a1a1a":"none"}}>
        <span style={{fontSize:13,color:"#d4d4d4"}}>{e.name}</span>
        <div style={{display:"flex",alignItems:"center",gap:6}}><span style={{fontSize:12,color:"#737373"}}>{e.reps}r ¬∑ {e.weight}kg</span>
          <button onClick={()=>setEntries(p=>p.filter(x=>x.id!==e.id))} style={{...S.microBtn,color:"#ef4444",width:22,height:22,fontSize:10}}>‚úï</button>
        </div>
      </div>))}
      <div style={{textAlign:"right",fontSize:12,color:"#555",marginTop:6}}>{tv}kg vol</div>
    </div>)}
    <div style={{display:"flex",gap:8}}>
      <button onClick={onSkip} style={{...S.modalBtn,flex:1,marginTop:0}}>Skip</button>
      <button onClick={()=>onSave(entries)} disabled={!entries.length} style={{...S.modalBtn,flex:1,marginTop:0,background:entries.length?"#eab308":"#333",color:entries.length?"#0a0a0a":"#666",fontWeight:700}}>Save to Stats</button>
    </div>
  </div></div>);
}
function MenuOverlay({onNav,onClose}){
  const items=[{k:"logs",i:"üìã",l:"Logs"},{k:"stats",i:"üìä",l:"Stats"},{k:"cxbuilder",i:"üì¶",l:"Complex Builder"},{k:"settings",i:"‚öôÔ∏è",l:"Settings"},{k:"readme",i:"üìñ",l:"Read Me"},{k:"about",i:"‚ÑπÔ∏è",l:"About"}];
  return(<div style={S.overlay} onClick={onClose}><div style={S.modal} onClick={e=>e.stopPropagation()}>
    <h3 style={S.modalTitle}>Menu</h3>
    {items.map(it=>(<button key={it.k} onClick={()=>onNav(it.k)} style={S.menuItem}><span style={{fontSize:18}}>{it.i}</span><span>{it.l}</span></button>))}
    <button onClick={onClose} style={{...S.modalBtn,marginTop:16}}>Close</button>
  </div></div>);
}

/* ‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê */
function LogsScreen({logs,del,onBack}){
  const[exp,setExp]=useState(null);const[cd,setCd]=useState(null);
  const pr=getPR(logs);const sw=useSwipe(onBack);
  return(<div ref={sw} style={S.page}>
    <Header title="Workout Logs" onBack={onBack}/>
    {logs.length===0&&<p style={{textAlign:"center",color:"#555",fontSize:14,marginTop:40}}>No workouts logged yet.</p>}
    {logs.map(log=>{
      const d=new Date(log.startTime);const nm=log.workoutName||`${timeOfDay(d)} Workout`;const isO=exp===log.id;
      const isP=!log.freestyle&&!log.partial&&log.totalVolume===pr&&pr>0;
      return(<div key={log.id} style={{background:"#141414",borderRadius:10,padding:"14px 16px",marginBottom:10}}>
        <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between"}}>
          <div style={{flex:1,cursor:"pointer"}} onClick={()=>setExp(isO?null:log.id)}>
            <span style={{display:"block",fontSize:11,color:"#555"}}>{fmtDate(d)}</span>
            <span style={{display:"flex",alignItems:"center",gap:6,fontSize:14,fontWeight:600,marginTop:4,flexWrap:"wrap"}}>
              {nm}
              {log.partial&&!log.freestyle&&<span style={{fontSize:10,color:"#ef4444",fontWeight:700,background:"rgba(239,68,68,0.15)",padding:"2px 6px",borderRadius:4}}>Partial</span>}
              {log.freestyle&&<span style={{fontSize:10,color:"#06b6d4",fontWeight:700,background:"rgba(6,182,212,0.15)",padding:"2px 6px",borderRadius:4}}>Freestyle</span>}
              {isP&&<span style={{fontSize:10,color:"#eab308",fontWeight:700,background:"rgba(234,179,8,0.15)",padding:"2px 6px",borderRadius:4}}>üèÜ PR</span>}
              {log.rpe&&<span style={{fontSize:10,color:rpeCol(log.rpe),fontWeight:700,background:`${rpeCol(log.rpe)}22`,padding:"2px 6px",borderRadius:4}}>RPE {log.rpe}</span>}
            </span>
            <span style={{display:"block",fontSize:12,color:"#737373",marginTop:4}}>{pl(log.completedRounds,"round")} ¬∑ {log.totalVolume.toLocaleString()}kg ¬∑ {fmtEl(log.elapsed)}{log.wallElapsed&&log.wallElapsed!==log.elapsed?` (${fmtEl(log.wallElapsed)} total)`:""}</span>
          </div>
          <div style={{display:"flex",gap:6}}><button onClick={()=>setExp(isO?null:log.id)} style={{...S.microBtn,fontSize:10}}>{isO?"‚ñ≤":"‚ñº"}</button>
            <button onClick={()=>setCd(log.id)} style={{...S.microBtn,color:"#ef4444"}}>‚úï</button></div>
        </div>
        {isO&&(<div style={{marginTop:12,paddingTop:12,borderTop:"1px solid #222"}}>
          {log.exercises.map((ex,i)=>(<div key={i} style={{padding:"6px 0",fontSize:13,borderBottom:i<log.exercises.length-1?"1px solid #1a1a1a":"none"}}>
            {isCx(ex)?(<><div style={{display:"flex",justifyContent:"space-between"}}><span style={{color:"#eab308"}}>{i+1}. {ex.name} <span style={{fontSize:10,opacity:0.7}}>COMPLEX</span></span><span style={{color:"#737373"}}>{ex.weight}kg</span></div>
              <div style={{fontSize:11,color:"#555",marginTop:2,paddingLeft:16}}>{ex.movements.map(m=>`${m.reps} ${m.name}`).join(" ‚Üí ")}</div>
            </>):(<div style={{display:"flex",justifyContent:"space-between"}}><span style={{color:"#a3a3a3"}}>{i+1}. {ex.name}</span><span style={{color:"#737373"}}>{ex.reps}r ¬∑ {ex.weight}kg</span></div>)}
          </div>))}
          {log.sets>1&&<div style={{textAlign:"right",fontSize:12,color:"#555",marginTop:4}}>√ó{log.sets} sets</div>}
        </div>)}
      </div>);
    })}
    {cd!==null&&<Confirm title="Delete Log?" message="This will permanently delete this workout log." onConfirm={()=>{del(cd);setCd(null)}} onCancel={()=>setCd(null)}/>}
  </div>);
}
function StatsScreen({logs,reset,onBack}){
  const[sb,setSb]=useState("volume");const[cr,setCr]=useState(false);const sw=useSwipe(onBack);
  const tv=logs.reduce((s,l)=>s+l.totalVolume,0);
  const mvs={};
  logs.forEach(log=>{if(!log.exercises||!log.exercises.length)return;const rc=log.completedRounds||0;for(let i=0;i<rc;i++){const ex=log.exercises[i%log.exercises.length];
    if(isCx(ex)){ex.movements.forEach(m=>{if(!mvs[m.name])mvs[m.name]={reps:0,vol:0};mvs[m.name].reps+=m.reps;mvs[m.name].vol+=m.reps*(ex.weight||0)})}
    else{if(!mvs[ex.name])mvs[ex.name]={reps:0,vol:0};mvs[ex.name].reps+=ex.reps;mvs[ex.name].vol+=ex.reps*(ex.weight||0)}}});
  const sorted=Object.entries(mvs).sort((a,b)=>sb==="volume"?b[1].vol-a[1].vol:b[1].reps-a[1].reps);
  return(<div ref={sw} style={S.page}>
    <Header title="Stats" onBack={onBack}/>
    <div style={{background:"#141414",borderRadius:12,padding:20,textAlign:"center",marginBottom:20}}>
      <div style={{fontSize:10,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:8}}>Lifetime Volume</div>
      <div style={{fontSize:32,fontWeight:800,color:"#eab308"}}>{tv.toLocaleString()} kg</div>
      <div style={{fontSize:12,color:"#737373",marginTop:6}}>{pl(logs.length,"workout")} logged</div>
    </div>
    {sorted.length>0&&(<>
      <div style={{display:"flex",gap:8,marginBottom:14}}>
        <button onClick={()=>setSb("volume")} style={{...S.sortBtn,background:sb==="volume"?"#eab308":"#1a1a1a",color:sb==="volume"?"#0a0a0a":"#737373"}}>By Volume</button>
        <button onClick={()=>setSb("reps")} style={{...S.sortBtn,background:sb==="reps"?"#eab308":"#1a1a1a",color:sb==="reps"?"#0a0a0a":"#737373"}}>By Reps</button>
      </div>
      <div style={{background:"#141414",borderRadius:10,overflow:"hidden"}}>
        {sorted.map(([nm,d],i)=>(<div key={nm} style={{display:"flex",justifyContent:"space-between",padding:"12px 16px",borderBottom:i<sorted.length-1?"1px solid #1f1f1f":"none"}}>
          <span style={{fontSize:13,fontWeight:600,color:"#d4d4d4",flex:1}}>{nm}</span>
          <span style={{fontSize:12,color:"#eab308",minWidth:70,textAlign:"right"}}>{d.reps.toLocaleString()} reps</span>
          <span style={{fontSize:12,color:"#737373",minWidth:80,textAlign:"right"}}>{d.vol.toLocaleString()}kg</span>
        </div>))}
      </div>
    </>)}
    <div style={{marginTop:40,textAlign:"center"}}><button onClick={()=>setCr(true)} style={{background:"none",border:"none",color:"#444",fontSize:12,cursor:"pointer",letterSpacing:1}}>Reset All Data</button></div>
    {cr&&<Confirm title="Reset All Data?" message="This will permanently delete ALL workout logs and stats." confirmText="Reset Everything" onConfirm={()=>{reset();setCr(false)}} onCancel={()=>setCr(false)}/>}
  </div>);
}
function SettingsScreen({accent,setAccent,sndIdx,setSndIdx,cdSecs,setCdSecs,restoreDefaults,onBack}){
  const sw=useSwipe(onBack);const[showRestore,setShowRestore]=useState(false);
  return(<div ref={sw} style={S.page}>
    <Header title="Settings" onBack={onBack}/>
    <div style={{marginBottom:32}}>
      <div style={{fontSize:11,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:14}}>Accent Color</div>
      <div style={{display:"flex",flexWrap:"wrap",gap:10}}>
        {ACCENTS.map(c=>(<button key={c.h} onClick={()=>{setAccent(c.h);store.set(STORE_ACCENT,c.h)}} style={{width:44,height:44,borderRadius:10,background:c.h,border:accent===c.h?"3px solid #fff":"3px solid transparent",cursor:"pointer",position:"relative",opacity:accent===c.h?1:0.6,transition:"opacity 0.2s"}}>
          {accent===c.h&&<span style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,color:c.h==="#e5e5e5"?"#000":"#fff"}}>‚úì</span>}
        </button>))}
      </div>
    </div>
    <div style={{marginBottom:32}}>
      <div style={{fontSize:11,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:14}}>Start Countdown</div>
      <div style={{display:"flex",gap:8}}>
        {[3,5,10,15].map(s=>(<button key={s} onClick={()=>setCdSecs(s)} style={{flex:1,padding:10,border:"none",borderRadius:8,fontSize:14,fontWeight:cdSecs===s?700:400,cursor:"pointer",fontFamily:"inherit",background:cdSecs===s?accent:"#1a1a1a",color:cdSecs===s?"#0a0a0a":"#737373"}}>{s}s</button>))}
      </div>
    </div>
    <div style={{marginBottom:32}}>
      <div style={{fontSize:11,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:14}}>Countdown Sound</div>
      {SOUNDS.map((s,i)=>(<div key={s.name} style={{display:"flex",alignItems:"center",gap:12,padding:"12px 0",borderBottom:i<SOUNDS.length-1?"1px solid #1a1a1a":"none"}}>
        <button onClick={()=>{setSndIdx(i);store.set(STORE_SOUND,i)}} style={{width:22,height:22,borderRadius:"50%",border:`2px solid ${sndIdx===i?accent:"#555"}`,background:sndIdx===i?accent:"transparent",cursor:"pointer",flexShrink:0}}/>
        <span style={{flex:1,fontSize:14,fontWeight:sndIdx===i?700:400,color:sndIdx===i?"#fafafa":"#a3a3a3"}}>{s.name}</span>
        <button onClick={()=>demoSnd(s)} style={{background:"none",border:"1px solid #333",borderRadius:6,color:"#a3a3a3",fontSize:11,padding:"5px 12px",cursor:"pointer",fontFamily:"inherit"}}>‚ñ∂ Demo</button>
      </div>))}
    </div>
    <div style={{marginTop:20,textAlign:"center"}}><button onClick={()=>setShowRestore(true)} style={{background:"none",border:"none",color:"#444",fontSize:12,cursor:"pointer",letterSpacing:1}}>Restore Default Complexes</button></div>
    {showRestore&&<Confirm title="Restore Defaults?" message="This will restore all default complexes that were deleted." confirmText="Restore" confirmColor={accent} onConfirm={()=>{restoreDefaults();setShowRestore(false)}} onCancel={()=>setShowRestore(false)}/>}
  </div>);
}
function ReadMeScreen({onBack}){
  const sw=useSwipe(onBack);
  return(<div ref={sw} style={S.page}>
    <Header title="Read Me" onBack={onBack}/>
    <div style={{color:"#a3a3a3",fontSize:14,lineHeight:2}}>
      <p style={{fontWeight:700,color:"#eab308",marginBottom:12}}>How to use the CS Kettlebell EMOM Timer</p>
      <p><b style={{color:"#d4d4d4"}}>Build your workout.</b> Select an exercise, set reps and weight, and tap + to add. Repeat for each round.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>Complexes.</b> Open the menu and tap "Complex Builder" to create a multi-movement round. Name it, add 2-5 movements with reps, and set a shared weight. Saved complexes appear in the dropdown for reuse.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>Freestyle.</b> Pick a duration and just go. Log exercises after if you want them in your stats.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>During the workout.</b> Use ‚ü® ‚ü© to skip or go back. Double-tap the ring to pause. Timer keeps running even if your screen locks.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>After the workout.</b> Rate your RPE, copy your summary, or continue freestyle.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>Settings.</b> Customize accent color and countdown sound from the menu.</p>
    </div>
  </div>);
}
function AboutScreen({onBack}){
  const sw=useSwipe(onBack);
  return(<div ref={sw} style={S.page}>
    <Header title="About" onBack={onBack}/>
    <div style={{textAlign:"center",marginTop:20}}>
      <div style={{fontSize:48,marginBottom:12}}>‚è±</div>
      <h2 style={{fontSize:20,fontWeight:800,color:"#eab308",letterSpacing:4,marginBottom:4}}>CS Kettlebell</h2>
      <h3 style={{fontSize:14,color:"#737373",letterSpacing:2,marginBottom:24}}>EMOM Timer</h3>
      <div style={{color:"#a3a3a3",fontSize:14,lineHeight:1.9,textAlign:"left",maxWidth:360,margin:"0 auto"}}>
        <p>Built by <span style={{color:"#eab308",fontWeight:700}}>clarenceos</span> using <span style={{color:"#d4d4d4",fontWeight:600}}>Claude AI</span>.</p>
        <p style={{marginTop:16}}>I got tired of paying $20 a year for a countdown timer. No ads. No subscriptions. Just you, your kettlebell, and a timer that works.</p>
      </div>
    </div>
  </div>);
}

/* ‚ïê‚ïê‚ïê WORKOUT BUILDER ‚ïê‚ïê‚ïê */
function Builder({exercises,setExercises,sets,setSets,onStart,onFreestyle,lib,addEx,wk,saveWk,delWk,wkName,setWkName,onNav,favs,toggleFav,cxs,saveCx,delCx,logs,accent}){
  const[sel,setSel]=useState("");const[reps,setReps]=useState(DEF_REPS);const[weight,setWeight]=useState(DEF_WEIGHT);
  const[showSave,setShowSave]=useState(false);const[showLoad,setShowLoad]=useState(false);const[editIdx,setEditIdx]=useState(null);
  const[showMenu,setShowMenu]=useState(false);const[showCxB,setShowCxB]=useState(false);const[cxBMode,setCxBMode]=useState("add");
  const[editCxQ,setEditCxQ]=useState(null);const[editCxF,setEditCxF]=useState(null);
  const[showFS,setShowFS]=useState(false);const[confirmDelCx,setConfirmDelCx]=useState(null);
  const[dismissed,setDismissed]=useState(()=>store.get(STORE_DISMISS)||false);
  const showInstall=!isStandalone()&&!dismissed;
  const streak=calcStreak(logs);

  const handleAdd=()=>{if(!sel)return;setExercises(p=>[...p,{id:Date.now(),name:sel,reps,weight}]);setSel("")};
  const pickCx=cx=>setExercises(p=>[...p,{id:Date.now(),name:cx.name,movements:cx.movements.map(m=>({...m})),weight:cx.weight}]);
  const saveCxNew=data=>{if(cxBMode==="add")setExercises(p=>[...p,{id:Date.now(),name:data.name,movements:data.movements,weight:data.weight}]);saveCx(data);setShowCxB(false)};
  const cxQSave=(idx,u)=>{setExercises(p=>p.map((e,i)=>i===idx?{...e,...u}:e));setEditCxQ(null)};
  const cxFSave=(idx,d)=>{setExercises(p=>p.map((e,i)=>i===idx?{...e,name:d.name,weight:d.weight,movements:d.movements}:e));saveCx(d);setEditCxF(null)};
  const remove=id=>setExercises(p=>p.filter(e=>e.id!==id));
  const move=(i,d)=>setExercises(p=>{const n=[...p];const j=i+d;if(j<0||j>=n.length)return p;[n[i],n[j]]=[n[j],n[i]];return n});
  const duplicate=i=>setExercises(p=>{const n=[...p];const cl={...p[i],id:Date.now()};if(cl.movements)cl.movements=cl.movements.map(m=>({...m}));n.splice(i+1,0,cl);return n});
  const updEx=(idx,u)=>{setExercises(p=>p.map((e,i)=>i===idx?{...e,...u}:e));setEditIdx(null)};
  const handleNav=k=>{setShowMenu(false);if(k==="cxbuilder"){setCxBMode("library");setShowCxB(true)}else onNav(k)};

  return(
    <div style={S.builder}>
      <div style={{paddingTop:"max(8px, env(safe-area-inset-top, 8px))",display:"flex",justifyContent:"flex-end",marginBottom:8}}>
        <button onClick={()=>setShowMenu(true)} style={{background:"none",border:"1px solid #333",borderRadius:8,color:"#a3a3a3",fontSize:18,cursor:"pointer",padding:"6px 10px",lineHeight:1}}>‚ò∞</button>
      </div>
      <div style={S.logoArea}>
        <div style={{fontSize:36,marginBottom:8}}>‚è±</div>
        <h1 style={S.titleMain}>CS Kettlebell</h1>
        <h1 style={{...S.titleSub,color:accent}}>EMOM Timer</h1>
        <div style={{fontSize:12,color:"#555",marginTop:-6,marginBottom:10}}>v3.2.5</div>
        {streak>0&&<div style={{fontSize:12,color:"#555",marginTop:6}}>üî• {streak} day streak</div>}
      </div>
      <div style={{marginBottom:12}}>
        <ExDD value={sel} onChange={setSel} lib={lib} onCustom={addEx} favs={favs} toggleFav={toggleFav} cxs={cxs} onPickCx={pickCx} onDelCx={name=>setConfirmDelCx(name)}/>
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginTop:14}}>
          <ScrollPicker key="rp" value={reps} onChange={setReps} max={20} suffix="reps"/>
          <ScrollPicker key="wp" value={weight} onChange={setWeight} max={99} suffix="kg"/>
          <button onClick={handleAdd} disabled={!sel} style={{...S.addBtn,opacity:sel?1:0.35,background:accent}}>+</button>
        </div>
      </div>
      {exercises.length>0&&(<div style={{marginBottom:4}}>{exercises.map((ex,i)=>{
        const c=isCx(ex);
        return(<div key={ex.id} style={{...S.exItem,background:c?"rgba(234,179,8,0.03)":"transparent"}}>
          <span style={S.roundNum}>{i+1}</span>
          <div style={{flex:1,minWidth:0}}>
            {c?(<>
              <span style={{display:"flex",alignItems:"center",gap:6}}>
                <span style={{fontSize:14,fontWeight:600}}>{ex.name}</span>
                <span style={{fontSize:9,color:accent,fontWeight:700,background:`${accent}22`,padding:"1px 6px",borderRadius:3}}>COMPLEX</span>
              </span>
              <span style={{fontSize:12,color:"#737373",display:"block",marginTop:2}}>{ex.movements.map(m=>`${m.reps} ${m.name.toLowerCase()}`).join(" ‚Üí ")}</span>
              <span style={{fontSize:11,color:"#555"}}>{exReps(ex)}r ¬∑ {ex.weight}kg ¬∑ {exVol(ex)}kg vol</span>
            </>):(<>
              <span style={{fontSize:14,fontWeight:600,display:"block"}}>{ex.name}</span>
              <span style={{fontSize:12,color:"#737373"}}>{ex.reps}r{ex.weight?` ¬∑ ${ex.weight}kg`:""}{ex.weight?<span style={{color:"#555"}}> ¬∑ {exVol(ex)}kg vol</span>:null}</span>
            </>)}
          </div>
          <div style={{display:"flex",gap:4}}>
            <button onClick={()=>move(i,-1)} style={S.microBtn} disabled={i===0}>‚Üë</button>
            <button onClick={()=>move(i,1)} style={S.microBtn} disabled={i===exercises.length-1}>‚Üì</button>
            <button onClick={()=>duplicate(i)} style={S.microBtn}>‚ßâ</button>
            <button onClick={()=>{c?setEditCxQ(i):setEditIdx(i)}} style={S.microBtn}>‚úé</button>
            <button onClick={()=>remove(ex.id)} style={{...S.microBtn,color:"#ef4444"}}>‚úï</button>
          </div>
        </div>);
      })}</div>)}
      {exercises.length>0&&<StatsBar exercises={exercises} sets={sets}/>}
      {exercises.length>0&&(<div style={{marginTop:16}}>
        <SetsSelector sets={sets} onChange={setSets}/>
        <button onClick={onStart} style={{...S.startBtn,background:accent}}>START ‚Äî {pl(exercises.length*sets,"round")}</button>
        <div style={S.saveLoadRow}>
          <button onClick={()=>setShowSave(true)} style={S.secBtn}>Save Workout</button>
          <button onClick={()=>setShowLoad(true)} style={S.secBtn}>Load Workout</button>
        </div>
      </div>)}
      {exercises.length===0&&(<div style={{display:"flex",gap:8,justifyContent:"center",marginTop:24}}>
        <button onClick={()=>setShowLoad(true)} style={S.secBtn}>Load Workout</button>
        <button onClick={()=>setShowFS(true)} style={{...S.secBtn,color:accent,borderColor:`${accent}66`}}>‚ö° Freestyle</button>
      </div>)}
      {exercises.length>0&&<div style={{textAlign:"center",marginTop:12}}><button onClick={()=>setShowFS(true)} style={{background:"none",border:"none",color:"#555",fontSize:12,cursor:"pointer",letterSpacing:1,fontFamily:"inherit"}}>‚ö° or just go Freestyle</button></div>}
      <p style={{textAlign:"center",color:"#555",fontSize:11,marginTop:28,letterSpacing:1}}>Don't forget to stretch and warm up before starting your workout.</p>
      {showInstall&&(<div style={{marginTop:16,background:"#141414",borderRadius:10,padding:"14px 16px",position:"relative"}}>
        <button onClick={()=>{setDismissed(true);store.set(STORE_DISMISS,true)}} style={{position:"absolute",top:8,right:10,background:"none",border:"none",color:"#555",cursor:"pointer",fontSize:14}}>‚úï</button>
        <div style={{fontSize:12,color:"#a3a3a3",lineHeight:1.7}}>
          <span style={{display:"block",fontWeight:700,color:"#d4d4d4",marginBottom:4}}>üì± Add to Home Screen</span>
          <span style={{display:"block",color:"#737373"}}>iPhone: Share ‚Üí Add to Home Screen</span>
          <span style={{display:"block",color:"#737373"}}>Android: ‚ãÆ ‚Üí Add to Home Screen</span>
        </div>
      </div>)}
      {confirmDelCx&&<Confirm title="Delete Complex?" message="This action cannot be undone." confirmText="Delete" onConfirm={()=>{delCx(confirmDelCx);setConfirmDelCx(null)}} onCancel={()=>setConfirmDelCx(null)}/>}
      {editIdx!==null&&exercises[editIdx]&&!isCx(exercises[editIdx])&&<EditModal exercise={exercises[editIdx]} onSave={u=>updEx(editIdx,u)} onCancel={()=>setEditIdx(null)}/>}
      {editCxQ!==null&&exercises[editCxQ]&&<CxQuickEdit entry={exercises[editCxQ]} onSave={u=>cxQSave(editCxQ,u)} onFull={()=>{setEditCxF(editCxQ);setEditCxQ(null)}} onCancel={()=>setEditCxQ(null)}/>}
      {editCxF!==null&&exercises[editCxF]&&<CxBuilder initial={exercises[editCxF]} onSave={d=>cxFSave(editCxF,d)} onCancel={()=>setEditCxF(null)} lib={lib}/>}
      {showCxB&&<CxBuilder onSave={saveCxNew} onCancel={()=>setShowCxB(false)} lib={lib}/>}
      {showSave&&<SaveModal onSave={n=>{saveWk(n,exercises.map(e=>isCx(e)?{name:e.name,movements:e.movements,weight:e.weight}:{name:e.name,reps:e.reps,weight:e.weight}),sets);setWkName(n);setShowSave(false)}} onCancel={()=>setShowSave(false)}/>}
      {showLoad&&<LoadModal wk={wk} onLoad={w=>{setExercises(w.exercises.map((e,i)=>({...e,id:Date.now()+i})));if(w.sets)setSets(w.sets);setWkName(w.name);setShowLoad(false)}} onDel={delWk} onCancel={()=>setShowLoad(false)}/>}
      {showFS&&<FreestyleSetup onStart={dur=>{setShowFS(false);onFreestyle(dur)}} onCancel={()=>setShowFS(false)}/>}
      {showMenu&&<MenuOverlay onNav={handleNav} onClose={()=>setShowMenu(false)}/>}
    </div>
  );
}

/* ‚ïê‚ïê‚ïê COUNTDOWN ‚ïê‚ïê‚ïê */
function Countdown({onDone,onCancel,muted,sndP,accent,cdSecs,acRef,onUserGesture}){
  const[count,setCount]=useState(cdSecs);const st=useRef(Date.now());const beeped=useRef(new Set());const can=useRef(false);
  useEffect(()=>{
    const iv=setInterval(()=>{if(can.current)return;const el=Math.floor((Date.now()-st.current)/1000);const rem=cdSecs-el;
      if(rem<=0){clearInterval(iv);if(!beeped.current.has(0)){beeped.current.add(0);mkBeep(acRef,sndP,"go",muted)}onDone();return}
      if(rem<=3&&!beeped.current.has(rem)){beeped.current.add(rem);mkBeep(acRef,sndP,rem===1?"go":"count",muted);vib(50)}setCount(rem);
    },100);return()=>clearInterval(iv);
  },[onDone,sndP,cdSecs]);
  const startNow=()=>{onUserGesture&&onUserGesture();can.current=true;onDone()};
  return(<div style={{...S.timerWrap,justifyContent:"center"}} onPointerDown={onUserGesture} onTouchStart={onUserGesture}>
    <div style={{fontSize:120,fontWeight:800,color:accent,fontVariantNumeric:"tabular-nums"}}>{count}</div>
    <div style={{fontSize:14,color:"#555",letterSpacing:4,marginTop:12,textTransform:"uppercase"}}>Get Ready</div>
    <button onClick={startNow} style={{marginTop:30,background:accent,border:"none",borderRadius:10,color:"#0a0a0a",padding:"12px 36px",fontSize:14,fontWeight:700,cursor:"pointer",fontFamily:"inherit",letterSpacing:1}}>Start Now</button>
    <button onClick={()=>{can.current=true;onCancel()}} style={{marginTop:12,background:"none",border:"1px solid #555",borderRadius:10,color:"#a3a3a3",padding:"10px 32px",fontSize:13,cursor:"pointer",fontFamily:"inherit",letterSpacing:1}}>Cancel</button>
  </div>);
}

/* ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê */
function getRingCol(sec,dyn){if(!dyn)return sec<=10?"#ef4444":"#eab308";if(sec>=40)return"#22c55e";if(sec>=25)return"#eab308";if(sec>=10)return"#f97316";return"#ef4444"}

function Timer({exercises,sets,onFinish,muted,mutedSt,toggleMute,sndP,accent,freeMode,freeRounds,acRef,onUserGesture}){
  const isFS=!!freeMode;
  const totalR=isFS?(freeRounds||999):exercises.length*sets;
  const[gR,setGR]=useState(0);const[sec,setSec]=useState(60);const[el,setEl]=useState(0);const[wallEl,setWallEl]=useState(0);
  const[paused,setPaused]=useState(false);const[done,setDone]=useState(false);
  const[stoppedE,setStoppedE]=useState(false);const[preview,setPreview]=useState(false);
  const[dynRing,setDynRing]=useState(true);const[confAct,setConfAct]=useState(null);

  const rStart=useRef(Date.now());const elBase=useRef(0);const elStart=useRef(Date.now());
  const wallStart=useRef(Date.now());
  const beeped=useRef(new Set());const lastRem=useRef(null);
  const pauseT=useRef(null);const doneR=useRef(false);const stoppedR=useRef(false);
  const gRR=useRef(0);const elR=useRef(0);const wallR=useRef(0);
  const intDur=60;

  const lastTap=useRef(0);
  const ringTap=()=>{onUserGesture&&onUserGesture();const now=Date.now();if(now-lastTap.current<300){togglePause();lastTap.current=0}else lastTap.current=now};

  const curEx=isFS?null:exercises[gR%exercises.length];
  const curSet=isFS?1:Math.floor(gR/exercises.length)+1;
  const curRound=isFS?gR+1:(gR%exercises.length)+1;
  const nextEx=isFS?null:(gR+1<totalR?exercises[(gR+1)%exercises.length]:null);

  useEffect(()=>{
    const wiv=setInterval(()=>{const w=Math.floor((Date.now()-wallStart.current)/1000);setWallEl(w);wallR.current=w},1000);
    return()=>clearInterval(wiv);
  },[]);

  useEffect(()=>{
    if(paused||doneR.current)return;
    const iv=setInterval(()=>{
      const now=Date.now();
      // --- Wall-clock round catch-up (iOS lock/background safe) ---
      let re=Math.floor((now-rStart.current)/1000);
      if(re<0) re=0;
      const adv=Math.floor(re/intDur);
      const mod=re%intDur;
      let rem=intDur-mod;
      if(rem===0) rem=intDur; // exact boundary -> start of next round at full duration
      if(adv>0){
        const nr=gRR.current+adv;
        if(nr>=totalR){doneR.current=true;setDone(true);return;}
        gRR.current=nr; setGR(nr);
        rStart.current += adv*intDur*1000;
        beeped.current.clear();
        lastRem.current=rem;
        setSec(rem);
        // do not replay missed beeps on catch-up
        return;
      }
      setSec(rem);

      const e=elBase.current+Math.floor((now-elStart.current)/1000);setEl(e);elR.current=e;

      // Beep thresholds: only on 1-second boundary crossings (no catch-up bursts)
      if(lastRem.current==null) lastRem.current=rem;
      const prev=lastRem.current;
      if(prev-rem===1){
        if(rem===3||rem===2||rem===1){
          if(!beeped.current.has(rem)){
            beeped.current.add(rem);
            mkBeep(acRef,sndP,rem===1?"go":"count",muted);
            vib(rem===1?200:100);
          }
        }
        if(rem===intDur && prev===1 && !beeped.current.has(0)){
          // optional: if we were at 1 then rolled, treat as GO (kept minimal)
          beeped.current.add(0);
          const nr=gRR.current+1;
          if(nr>=totalR){doneR.current=true;setDone(true)}
          else{gRR.current=nr;setGR(nr);rStart.current=Date.now();beeped.current.clear();lastRem.current=intDur;setSec(intDur)}
        }
      }
      lastRem.current=rem;

      // Standard rollover when rem hits 0 not used anymore since rem becomes intDur on boundary,
      // but keep safety: if now has passed boundary due to scheduling jitter
      if(mod===0 && re>0 && prev!==intDur){
        const nr=gRR.current+1;
        if(nr>=totalR){doneR.current=true;setDone(true)}
        else{gRR.current=nr;setGR(nr);rStart.current=Date.now();beeped.current.clear();lastRem.current=intDur;setSec(intDur)}
      }
    },150);return()=>clearInterval(iv);
  },[paused,totalR,sndP]);

  const togglePause=()=>{if(paused){const d=Date.now()-pauseT.current;rStart.current+=d;elStart.current+=d;setPaused(false)}else{pauseT.current=Date.now();setPaused(true)}};
  const goNext=()=>{onUserGesture&&onUserGesture();const n=gRR.current+1;if(n>=totalR){doneR.current=true;setDone(true);return}gRR.current=n;setGR(n);rStart.current=Date.now();beeped.current.clear();lastRem.current=intDur;setSec(intDur)};
  const goPrev=()=>{onUserGesture&&onUserGesture();if(gRR.current<=0)return;gRR.current-=1;setGR(gRR.current);rStart.current=Date.now();beeped.current.clear();lastRem.current=intDur;setSec(intDur)};
  const trigStop=t=>{if(!paused){pauseT.current=Date.now();setPaused(true)}setConfAct(t)};
  const cancelConf=()=>{setConfAct(null);if(pauseT.current){const d=Date.now()-pauseT.current;rStart.current+=d;elStart.current+=d}setPaused(false)};
  const confStop=()=>{setConfAct(null);stoppedR.current=true;setStoppedE(true);doneR.current=true;setDone(true)};

  const totVol=isFS?0:exercises.reduce((s,e)=>s+exVol(e),0)*sets;
  const volForR=n=>{if(isFS)return 0;let v=0;for(let i=0;i<n;i++)v+=exVol(exercises[i%exercises.length]);return v};

  useEffect(()=>{if(done){
    const comp=stoppedR.current?gRR.current:totalR;
    const vol=isFS?0:stoppedR.current?volForR(gRR.current):totVol;
    onFinish({completedRounds:comp,totalRounds:totalR,elapsed:elR.current,wallElapsed:wallR.current,totalVolume:vol,partial:stoppedR.current||isFS,freestyle:isFS});
  }},[done]);

  const prog=sec/intDur;const ringCol=getRingCol(sec,dynRing);

  return(
    <div style={S.timerWrap} onPointerDown={onUserGesture} onTouchStart={onUserGesture}>
      <div style={{width:"100%",maxWidth:500,margin:"0 auto",paddingTop:"max(12px, env(safe-area-inset-top, 12px))"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4,padding:"0 4px"}}>
          <div>{isFS?<span style={{...S.roundLbl,color:accent}}>Freestyle ¬∑ Round {gR+1}{freeRounds?` / ${freeRounds}`:""}</span>
            :(<><span style={S.roundLbl}>Round {curRound}/{exercises.length}</span>{sets>1&&<span style={{...S.roundLbl,marginLeft:10,color:accent}}>Set {curSet}/{sets}</span>}</>)}</div>
          <div style={{display:"flex",gap:6}}>
            <button onClick={()=>setDynRing(!dynRing)} style={{...S.prevTog,fontSize:11,padding:"4px 8px",color:dynRing?accent:"#555"}}>{dynRing?"‚óâ":"‚óã"}</button>
            <button onClick={toggleMute} style={{...S.prevTog,fontSize:13,padding:"4px 8px",color:mutedSt?"#ef4444":"#a3a3a3"}}>{mutedSt?"üîá":"üîä"}</button>
            {!isFS&&<button onClick={()=>setPreview(!preview)} style={S.prevTog}>{preview?"Hide":"Preview"}</button>}
            <button onClick={()=>trigStop("home")} style={{...S.prevTog,fontSize:13}}>‚åÇ</button>
          </div>
        </div>
      </div>

      {confAct&&<Confirm title={confAct==="stop"?"Stop Workout?":"Return Home?"} message="Your progress will be saved." onConfirm={confStop} onCancel={cancelConf}/>}
      {preview&&!isFS&&(<div style={S.overlay}><div style={S.modal}>
        <h3 style={S.modalTitle}>Workout Plan{sets>1?` ¬∑ ${pl(sets,"Set")}`:""}</h3>
        {exercises.map((x,i)=>{const isA=i===gR%exercises.length;const isP=i<gR%exercises.length;return(
          <div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 8px",borderRadius:6,opacity:isP?0.35:1,background:isA?`${accent}18`:"transparent",borderLeft:isA?`3px solid ${accent}`:"3px solid transparent"}}>
            <span style={{fontSize:12,color:"#737373",width:20,textAlign:"center"}}>{i+1}</span>
            <span style={{flex:1,fontSize:14,fontWeight:600}}>{x.name}</span>
            <span style={{fontSize:12,color:"#a3a3a3"}}>{isCx(x)?`${exReps(x)}r ¬∑ ${x.weight}kg`:`${x.reps}r${x.weight?` ¬∑ ${x.weight}kg`:""}`}</span>
          </div>)})}
        <button onClick={()=>setPreview(false)} style={S.modalBtn}>Close</button>
      </div></div>)}

      <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"100%",maxWidth:320,margin:"0 auto"}}>
        <div style={{textAlign:"center",marginBottom:4}}>
          {isFS?(<><span style={{display:"block",fontSize:28,fontWeight:700,textTransform:"uppercase",letterSpacing:4,color:accent}}>FREESTYLE</span>
            <span style={{display:"block",fontSize:16,color:"#555",marginTop:2}}>Round {gR+1}</span></>)
          :isCx(curEx)?(<><span style={{display:"block",fontSize:26,fontWeight:700,textTransform:"uppercase",letterSpacing:2}}>{curEx.name}</span>
            <div style={{marginTop:6}}>{curEx.movements.map((m,mi)=>(<div key={mi} style={{fontSize:18,color:accent,fontWeight:600,lineHeight:1.6}}>{m.reps}x {m.name}</div>))}</div>
            <span style={{display:"block",fontSize:15,color:"#555",marginTop:4}}>{curEx.weight}kg</span></>)
          :(<><span style={{display:"block",fontSize:28,fontWeight:700,textTransform:"uppercase",letterSpacing:2}}>{curEx.name}</span>
            <span style={{display:"block",fontSize:22,color:accent,marginTop:2,fontWeight:700}}>{curEx.reps} reps{curEx.weight?` ¬∑ ${curEx.weight}kg`:""}</span></>)}
        </div>
        <div onClick={ringTap} style={{position:"relative",width:"100%",aspectRatio:"1",cursor:"pointer"}}>
          <svg viewBox="0 0 200 200" style={{width:"100%",height:"100%"}}>
            <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="6"/>
            <circle cx="100" cy="100" r="90" fill="none" stroke={ringCol} strokeWidth="6" strokeLinecap="round" strokeDasharray={2*Math.PI*90} strokeDashoffset={2*Math.PI*90*(1-prog)} transform="rotate(-90 100 100)" style={{transition:"stroke-dashoffset 0.3s linear,stroke 0.5s ease"}}/>
          </svg>
          <div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
            <span style={{fontSize:60,fontWeight:800,fontVariantNumeric:"tabular-nums",letterSpacing:4,color:sec<=10?"#ef4444":"#fafafa"}}>{fmt(sec)}</span>
            <span style={{fontSize:14,color:"#737373",fontStyle:"italic",letterSpacing:3,marginTop:4,visibility:paused&&!confAct?"visible":"hidden"}}>PAUSED</span>
          </div>
        </div>
        {!isFS&&<ProgBar current={gR} total={totalR} sets={sets} accent={accent}/>}
        <div style={{width:"100%",marginTop:isFS?6:0}}>
          {isFS?<div style={S.upNext}><span style={S.upNextLbl}>Freestyle</span><span style={S.upNextTxt}>Go at your own pace üí™</span></div>
          :nextEx?<div style={S.upNext}><span style={S.upNextLbl}>Up next</span><span style={S.upNextTxt}>{isCx(nextEx)?`${nextEx.name} ‚Äî ${nextEx.movements.map(m=>`${m.reps} ${m.name.toLowerCase()}`).join(" ‚Üí ")}`:`${nextEx.name} ‚Äî ${nextEx.reps}r${nextEx.weight?` ¬∑ ${nextEx.weight}kg`:""}`}</span></div>
          :<div style={S.upNext}><span style={S.upNextLbl}>Last round</span><span style={S.upNextTxt}>Finish strong üí™</span></div>}
        </div>
      </div>

      <div style={{width:"100%",maxWidth:500,margin:"0 auto",paddingBottom:12}}>
        <div style={{display:"flex",gap:10,justifyContent:"center",alignItems:"center",marginBottom:12}}>
          <button onClick={goPrev} disabled={gR<=0} style={{...S.skipBtn,opacity:gR<=0?0.25:1}}>‚ü®</button>
          <button onClick={togglePause} style={S.ctrlBtn}>{paused?"‚ñ∂ Resume":"‚ùö‚ùö Pause"}</button>
          <button onClick={()=>trigStop("stop")} style={S.stopBtn}>‚ñ† Stop</button>
          <button onClick={goNext} style={S.skipBtn}>‚ü©</button>
        </div>
        <div style={{display:"flex",gap:16,justifyContent:"center",fontSize:11,color:"#4a4a4a",fontVariantNumeric:"tabular-nums"}}>
          <span>{fmtEl(el)} active</span><span>¬∑</span><span>{fmtEl(wallEl)} total</span>{!isFS&&<><span>¬∑</span><span>{totVol.toLocaleString()}kg vol</span></>}
        </div>
      </div>
    </div>
  );
}

/* ‚ïê‚ïê‚ïê COMPLETION ‚ïê‚ïê‚ïê */
function Complete({data,exercises,sets,wkName,onHome,onFreestyle,logs,accent,onRPE,lib,onFSLog,onUserGesture}){
  const[copied,setCopied]=useState(false);const[rpe,setRpe]=useState(null);const[showFSLog,setShowFSLog]=useState(false);
  const d=new Date();
  const prevPR=logs.length>1?getPR(logs.slice(1)):0;
  const isNewPR=!data.freestyle&&!data.partial&&data.totalVolume>prevPR&&prevPR>0;

  const genSum=()=>{
    const nm=wkName||`${timeOfDay(d)} Workout`;
    let t=data.freestyle?"‚ö° CS Kettlebell Freestyle\n":data.partial?"‚èπ CS Kettlebell EMOM (Partial)\n":"üèÅ CS Kettlebell EMOM\n";
    t+=`${fmtDate(d)} ¬∑ ${pl(data.completedRounds,"round")}${data.partial&&!data.freestyle?` of ${data.totalRounds}`:""}\n`;
    if(!data.freestyle){t+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
      exercises.forEach((ex,i)=>{t+=isCx(ex)?`${i+1}. ${ex.name} (${ex.movements.map(m=>`${m.reps} ${m.name.toLowerCase()}`).join(" ‚Üí ")}) ¬∑ ${ex.weight}kg\n`:`${i+1}. ${ex.name} ‚Äî ${ex.reps}r ¬∑ ${ex.weight}kg\n`});
      if(sets>1)t+=`√ó${sets} sets\n`;t+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
      t+=`Volume: ${data.totalVolume.toLocaleString()}kg ¬∑ Active: ${fmtEl(data.elapsed)} ¬∑ Total: ${fmtEl(data.wallElapsed||data.elapsed)}`}
    else t+=`Time: ${fmtEl(data.wallElapsed||data.elapsed)}`;
    if(rpe)t+=`\nRPE: ${rpe}/10`;return t;
  };
  const copySum=async()=>{try{await navigator.clipboard.writeText(genSum());setCopied(true);setTimeout(()=>setCopied(false),2000)}
    catch{try{const ta=document.createElement("textarea");ta.value=genSum();document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);setCopied(true);setTimeout(()=>setCopied(false),2000)}catch{}}};
  const handleRPE=v=>{setRpe(v);onRPE(v)};

  return(<div style={S.timerWrap} onPointerDown={onUserGesture} onTouchStart={onUserGesture}>
    <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",padding:20}}>
      <div style={{fontSize:48,marginBottom:12}}>{data.freestyle?"‚ö°":data.partial?"‚èπ":"üèÅ"}</div>
      <h2 style={{fontSize:22,fontWeight:800,letterSpacing:3,margin:"0 0 4px"}}>{data.freestyle?"Freestyle Complete":data.partial?"Workout Stopped":"Workout Complete"}</h2>
      {isNewPR&&<div style={{fontSize:14,color:accent,fontWeight:700,margin:"6px 0"}}>üèÜ New Volume PR! Previous best: {prevPR.toLocaleString()}kg</div>}
      {data.partial&&!data.freestyle&&<span style={{fontSize:11,color:"#ef4444",fontWeight:700,background:"rgba(239,68,68,0.15)",padding:"3px 10px",borderRadius:4,marginBottom:8,display:"inline-block"}}>Partial</span>}
      <div style={{color:"#a3a3a3",fontSize:14,lineHeight:1.8,marginBottom:16}}>
        <div>{pl(data.completedRounds,"round")}{!data.freestyle?` of ${data.totalRounds}`:""} completed</div>
        {!data.freestyle&&<div>{data.totalVolume.toLocaleString()}kg volume</div>}
        <div style={{color:"#555",marginTop:4}}>Active: {fmtEl(data.elapsed)} ¬∑ Total: {fmtEl(data.wallElapsed||data.elapsed)}</div>
      </div>
      {!data.freestyle&&(<div style={{background:"#141414",borderRadius:10,padding:16,width:"100%",maxWidth:360,marginBottom:16,textAlign:"left"}}>
        <div style={{fontSize:10,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:10,textAlign:"center"}}>Workout Summary</div>
        {exercises.map((ex,i)=>(<div key={i} style={{padding:"6px 0",borderBottom:i<exercises.length-1?"1px solid #1f1f1f":"none"}}>
          {isCx(ex)?<><div style={{fontSize:13,color:"#d4d4d4",fontWeight:600}}>{i+1}. {ex.name}</div><div style={{fontSize:12,color:"#737373",marginTop:2}}>{exReps(ex)}r ¬∑ {ex.weight}kg ¬∑ {exVol(ex)}kg vol</div></>
          :<div style={{display:"flex",justifyContent:"space-between"}}><span style={{fontSize:13,color:"#d4d4d4"}}>{i+1}. {ex.name}</span><span style={{fontSize:12,color:"#737373"}}>{ex.reps}r ¬∑ {ex.weight}kg</span></div>}
        </div>))}
        {sets>1&&<div style={{textAlign:"right",fontSize:12,color:accent,marginTop:8}}>√ó{sets} sets</div>}
      </div>)}
      <div style={{width:"100%",maxWidth:360,marginBottom:20}}><RPESlider value={rpe} onChange={handleRPE}/></div>
      <div style={{display:"flex",gap:8,width:"100%",maxWidth:360}}>
        <button onClick={copySum} style={{...S.secBtn,flex:"none",padding:"12px 20px",fontSize:12}}>{copied?"‚úì Copied":"üìã Copy"}</button>
        <button onClick={onHome} style={{...S.startBtn,flex:1,background:accent}}>Return to Home</button>
      </div>
      {!data.freestyle&&<button onClick={()=>onFreestyle()} style={{marginTop:10,background:"none",border:"1px solid #333",borderRadius:10,color:"#a3a3a3",padding:"10px 24px",fontSize:13,cursor:"pointer",fontFamily:"inherit",letterSpacing:1}}>‚ö° Continue Freestyle</button>}
      {data.freestyle&&<button onClick={()=>setShowFSLog(true)} style={{marginTop:10,background:"none",border:`1px solid ${accent}66`,borderRadius:10,color:accent,padding:"10px 24px",fontSize:13,cursor:"pointer",fontFamily:"inherit",letterSpacing:1}}>üìù Log Exercises</button>}
    </div>
    {showFSLog&&<FreestyleLogModal rounds={data.completedRounds} lib={lib} onSave={entries=>{onFSLog(entries);setShowFSLog(false)}} onSkip={()=>setShowFSLog(false)}/>}
  </div>);
}

/* ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê */
function EmomApp(){
  const[screen,setScreen]=useState("home");
  const[exercises,setExercises]=useState([]);const[sets,setSets]=useState(1);
  const[wkName,setWkName]=useState(null);const[compData,setCompData]=useState(null);
  const[accent,setAccent]=useState(()=>store.get(STORE_ACCENT)||"#eab308");
  const[sndIdx,setSndIdx]=useState(()=>store.get(STORE_SOUND)||0);
  const[cdSecs,setCdSecs]=useState(()=>store.get(STORE_CD)||5);
  const mutedRef=useRef(store.get(STORE_MUTE)||false);
  const[mutedSt,setMutedSt]=useState(mutedRef.current);
  const acRef=useRef(null);
  const audioDirtyRef=useRef(false);

  const stRef=useRef(null);const fsRef=useRef(null);const logIdRef=useRef(null);

  const{lib,add:addEx}=useExLib();
  const{wk,save:saveWk,del:delWk}=useWorkouts();
  const{logs,add:addLog,del:delLog,upd:updLog,reset:resetLogs}=useLogs();
  const{favs,toggle:toggleFav}=useFavs();
  const{cxs,save:saveCx,del:delCx,restoreDefaults}=useCxLib();
  const sndP=SOUNDS[sndIdx]||SOUNDS[0];

  // v3.2.1: iOS PWA lifecycle guardrails (audio + wake lock)
  const wlRef=useRef(null);
  const wlWanted=useRef(false);

  // Global flag used by mkBeep to avoid attempting audio immediately after returning from background.
  useEffect(()=>{window.__CS_AUDIO_NEEDS_GESTURE=false;},[]);

  const acquireWake=useCallback(async()=>{
    wlWanted.current=true;
    if(!("wakeLock" in navigator) || !navigator.wakeLock || !navigator.wakeLock.request) return;
    try{
      if(wlRef.current) return;
      const s=await navigator.wakeLock.request("screen");
      wlRef.current=s;
      // Re-acquire if OS releases while workout active
      s.addEventListener("release",()=>{wlRef.current=null;if(wlWanted.current) acquireWake();});
    }catch{}
  },[]);
  const releaseWake=useCallback(()=>{
    wlWanted.current=false;
    try{wlRef.current&&wlRef.current.release&&wlRef.current.release().catch(()=>{});}catch{}
    wlRef.current=null;
  },[]);
  useEffect(()=>{
    const onVis=()=>{
      if(document.visibilityState==="hidden"){
        audioDirtyRef.current=true;
        // Returning later will require a user gesture to re-enable audio on iOS.
        window.__CS_AUDIO_NEEDS_GESTURE=true;
      }
      if(document.visibilityState==="visible"){
        window.__CS_AUDIO_NEEDS_GESTURE=true;
        if(wlWanted.current) acquireWake();
      }
    };
    document.addEventListener("visibilitychange",onVis);
    return()=>document.removeEventListener("visibilitychange",onVis);
  },[acquireWake]);
  useEffect(()=>{
    const onPH=()=>{audioDirtyRef.current=true;window.__CS_AUDIO_NEEDS_GESTURE=true;};
    window.addEventListener("pagehide",onPH);
    return()=>window.removeEventListener("pagehide",onPH);
  },[]);

  useEffect(()=>{if(screen!=="countdown"&&screen!=="timer")releaseWake()},[screen,releaseWake]);

  const initAudio=()=>{
    try{
      const Ctx=(window.AudioContext||window.webkitAudioContext);
      if(!Ctx) return;

      // iOS PWA: after background/app-switch, audio can become unrecoverable even if state looks "running".
      // Mark audioDirtyRef on visibility/pagehide; on next user gesture, force a fresh context.
      if(audioDirtyRef.current){
        try{acRef.current&&acRef.current.close&&acRef.current.close().catch(()=>{});}catch{}
        acRef.current=null;
        audioDirtyRef.current=false;
      }

      if(!acRef.current || acRef.current.state==="closed"){
        acRef.current=new Ctx();
      }

      // Try to resume; if resume fails, mark dirty so the next gesture forces a rebuild.
      if(acRef.current && acRef.current.state==="suspended" && acRef.current.resume){
        acRef.current.resume().catch(()=>{audioDirtyRef.current=true;});
      }else if(acRef.current && acRef.current.state==="running" && acRef.current.resume){
        // Some iOS states claim running but still need a nudge; harmless on others.
        acRef.current.resume().catch(()=>{audioDirtyRef.current=true;});
      }
    }catch{}
  };
  const onUserGesture=()=>{
    // Called from user taps within Timer/Countdown to re-arm audio + wake lock after iOS lock/background
    window.__CS_AUDIO_NEEDS_GESTURE=false;
    initAudio();
    if(screen==="countdown"||screen==="timer") acquireWake();
  };
  const toggleMute=()=>{initAudio();mutedRef.current=!mutedRef.current;setMutedSt(mutedRef.current);store.set(STORE_MUTE,mutedRef.current)};
  const handleStart=()=>{initAudio();acquireWake();stRef.current=new Date();fsRef.current=null;setScreen("countdown")};
  const handleFS=dur=>{initAudio();acquireWake();stRef.current=new Date();fsRef.current={rounds:dur};setScreen("countdown")};
  const handlePostFS=()=>{initAudio();acquireWake();stRef.current=new Date();fsRef.current={rounds:null};setScreen("countdown")};
const handleCDDone=useCallback(()=>setScreen("timer"),[]);
  const handleCDCancel=useCallback(()=>{releaseWake();setScreen("home")},[releaseWake]);
  const handleSetCd=v=>{setCdSecs(v);store.set(STORE_CD,v)};

  const handleFinish=useCallback(data=>{releaseWake();
    const id=Date.now();logIdRef.current=id;
    addLog({id,startTime:stRef.current.toISOString(),workoutName:data.freestyle?"Freestyle":wkName,
      exercises:data.freestyle?[]:exercises.map(e=>isCx(e)?{name:e.name,movements:e.movements,weight:e.weight}:{name:e.name,reps:e.reps,weight:e.weight}),
      sets:data.freestyle?1:sets,completedRounds:data.completedRounds,totalRounds:data.totalRounds,
      elapsed:data.elapsed,wallElapsed:data.wallElapsed||data.elapsed,totalVolume:data.totalVolume,partial:data.partial,freestyle:data.freestyle||false});
    setCompData(data);setScreen("complete");
  },[exercises,sets,wkName,addLog]);

  const handleRPE=useCallback(r=>{if(logIdRef.current)updLog(logIdRef.current,{rpe:r})},[updLog]);
  const handleFSLog=useCallback(entries=>{
    if(!logIdRef.current||!entries.length)return;
    const vol=entries.reduce((s,e)=>s+e.reps*(e.weight||0),0);
    updLog(logIdRef.current,{exercises:entries,totalVolume:vol});
  },[updLog]);

  const goHome=()=>setScreen("home");

  if(screen==="countdown")return <Countdown onDone={handleCDDone} onCancel={handleCDCancel} muted={mutedRef} sndP={sndP} accent={accent} cdSecs={cdSecs} acRef={acRef} onUserGesture={onUserGesture}/>;
  if(screen==="timer")return <Timer exercises={exercises} sets={sets} onFinish={handleFinish} muted={mutedRef} mutedSt={mutedSt} toggleMute={toggleMute} sndP={sndP} accent={accent} freeMode={!!fsRef.current} freeRounds={fsRef.current?.rounds} acRef={acRef} onUserGesture={onUserGesture}/>;
  if(screen==="complete")return <Complete data={compData} exercises={exercises} sets={sets} wkName={wkName} onHome={goHome} onFreestyle={handlePostFS} logs={logs} accent={accent} onRPE={handleRPE} lib={lib} onFSLog={handleFSLog} onUserGesture={onUserGesture}/>;
  if(screen==="logs")return <LogsScreen logs={logs} del={delLog} onBack={goHome}/>;
  if(screen==="stats")return <StatsScreen logs={logs} reset={resetLogs} onBack={goHome}/>;
  if(screen==="settings")return <SettingsScreen accent={accent} setAccent={setAccent} sndIdx={sndIdx} setSndIdx={setSndIdx} cdSecs={cdSecs} setCdSecs={handleSetCd} restoreDefaults={restoreDefaults} onBack={goHome}/>;
  if(screen==="readme")return <ReadMeScreen onBack={goHome}/>;
  if(screen==="about")return <AboutScreen onBack={goHome}/>;
  return <Builder exercises={exercises} setExercises={setExercises} sets={sets} setSets={setSets} onStart={handleStart} onFreestyle={handleFS} lib={lib} addEx={addEx} wk={wk} saveWk={saveWk} delWk={delWk} wkName={wkName} setWkName={setWkName} onNav={setScreen} favs={favs} toggleFav={toggleFav} cxs={cxs} saveCx={saveCx} delCx={delCx} logs={logs} accent={accent}/>;
}

/* ‚ïê‚ïê‚ïê STYLES ‚ïê‚ïê‚ïê */
const S={
  builder:{minHeight:"100vh",background:"#0a0a0a",color:"#fafafa",padding:"0 16px 48px",fontFamily:"inherit",maxWidth:520,margin:"0 auto"},
  logoArea:{textAlign:"center",marginBottom:20},
  titleMain:{fontSize:16,fontWeight:600,letterSpacing:4,margin:0,color:"#a3a3a3",textTransform:"uppercase"},
  titleSub:{fontSize:32,fontWeight:800,letterSpacing:6,margin:"4px 0 0"},
  input:{background:"#171717",border:"1px solid #262626",borderRadius:8,color:"#fafafa",padding:"10px 12px",fontSize:14,fontFamily:"inherit",outline:"none",width:"100%",boxSizing:"border-box"},
  editLabel:{display:"block",fontSize:10,color:"#555",letterSpacing:2,textTransform:"uppercase",marginBottom:6,textAlign:"center"},
  addBtn:{color:"#0a0a0a",border:"none",borderRadius:12,width:52,height:52,fontSize:26,fontWeight:700,cursor:"pointer",flexShrink:0,alignSelf:"center"},
  dropdown:{position:"absolute",top:"100%",left:0,right:0,background:"#1c1c1c",border:"1px solid #333",borderRadius:8,marginTop:4,zIndex:50,overflow:"hidden"},
  ddItem:{padding:"11px 14px",fontSize:14,cursor:"pointer",borderBottom:"1px solid #1f1f1f"},
  exItem:{display:"flex",alignItems:"center",gap:10,padding:"11px 0",borderBottom:"1px solid #1a1a1a"},
  roundNum:{width:26,height:26,borderRadius:"50%",background:"#262626",display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:700,color:"#a3a3a3",flexShrink:0},
  microBtn:{background:"none",border:"1px solid #333",borderRadius:4,color:"#737373",width:26,height:26,fontSize:12,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0},
  wBtn:{width:32,height:32,borderRadius:"50%",background:"#171717",border:"1px solid #333",color:"#fafafa",fontSize:18,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0},
  statsBar:{background:"#111",borderRadius:10,padding:"14px 20px",marginTop:12},
  statBlk:{display:"inline-flex",alignItems:"baseline",gap:6},
  statVal:{fontSize:22,fontWeight:800,color:"#fafafa"},
  statLbl:{fontSize:11,color:"#555",letterSpacing:1},
  setsBtn:{width:40,height:40,borderRadius:"50%",background:"#171717",border:"1px solid #333",color:"#fafafa",fontSize:22,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0},
  startBtn:{width:"100%",padding:"14px",color:"#0a0a0a",border:"none",borderRadius:10,fontSize:15,fontWeight:800,fontFamily:"inherit",letterSpacing:2,cursor:"pointer"},
  saveLoadRow:{display:"flex",gap:8,marginTop:10},
  secBtn:{flex:1,padding:"11px 16px",background:"transparent",border:"1px solid #333",borderRadius:10,color:"#a3a3a3",fontSize:13,fontWeight:600,cursor:"pointer",letterSpacing:1,fontFamily:"inherit"},
  overlay:{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center",padding:20},
  modal:{background:"#171717",borderRadius:14,padding:24,width:"100%",maxWidth:380,maxHeight:"80vh",overflowY:"auto"},
  modalTitle:{fontSize:16,fontWeight:700,letterSpacing:2,textAlign:"center",margin:"0 0 16px"},
  modalBtn:{width:"100%",marginTop:16,padding:"10px",background:"#262626",color:"#fafafa",border:"none",borderRadius:8,fontSize:13,cursor:"pointer",fontFamily:"inherit"},
  loadItem:{display:"flex",alignItems:"center",gap:8,padding:"12px 8px",borderBottom:"1px solid #222",cursor:"pointer"},
  menuItem:{width:"100%",display:"flex",alignItems:"center",gap:14,padding:"14px 16px",background:"#1a1a1a",border:"none",borderRadius:8,color:"#d4d4d4",fontSize:14,fontWeight:600,cursor:"pointer",marginBottom:8,letterSpacing:1},
  timerWrap:{minHeight:"100vh",background:"#0a0a0a",color:"#fafafa",fontFamily:"'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace",display:"flex",flexDirection:"column",alignItems:"center",padding:"0 20px 20px",position:"relative"},
  roundLbl:{fontSize:13,color:"#a3a3a3",letterSpacing:1},
  prevTog:{background:"none",border:"1px solid #333",borderRadius:6,color:"#a3a3a3",fontSize:12,padding:"5px 12px",cursor:"pointer",fontFamily:"inherit"},
  ctrlBtn:{background:"#262626",color:"#fafafa",border:"none",borderRadius:10,padding:"12px 24px",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},
  stopBtn:{background:"transparent",color:"#ef4444",border:"1px solid #ef4444",borderRadius:10,padding:"12px 24px",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},
  skipBtn:{background:"none",border:"1px solid #333",borderRadius:10,color:"#a3a3a3",width:40,height:44,fontSize:18,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0,fontFamily:"inherit"},
  upNext:{background:"#141414",borderRadius:10,padding:"12px 20px",width:"100%",textAlign:"center"},
  upNextLbl:{display:"block",fontSize:10,letterSpacing:3,color:"#737373",textTransform:"uppercase",marginBottom:3},
  upNextTxt:{fontSize:14,color:"#d4d4d4"},
  page:{minHeight:"100vh",background:"#0a0a0a",color:"#fafafa",padding:"0 16px 48px",fontFamily:"'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace",maxWidth:520,margin:"0 auto"},
  sortBtn:{flex:1,padding:"10px",border:"none",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer",letterSpacing:1,fontFamily:"inherit"},
};

ReactDOM.createRoot(document.getElementById("root")).render(<EmomApp/>);
</script>
</body>
</html>
